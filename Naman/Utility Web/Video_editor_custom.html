<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowCut Pro - Advanced Video Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Montserrat:wght@400;700&family=Playfair+Display:wght@700&family=Bebas+Neue&family=Oswald:wght@500&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; box-sizing: border-box; }
        
        :root {
            --bg-primary: #0a0a12;
            --bg-secondary: #12121f;
            --bg-tertiary: #1a1a2e;
            --bg-quaternary: #252540;
            --accent-primary: #8b5cf6;
            --accent-secondary: #ec4899;
            --accent-tertiary: #06b6d4;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #606070;
            --border-color: #2a2a40;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--bg-quaternary); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #3a3a5a; }
        
        body { 
            background: var(--bg-primary); 
            color: var(--text-primary); 
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        
        /* ===== TIMELINE STYLES ===== */
        .timeline-clip {
            transition: transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease;
            cursor: grab;
            border-radius: 6px;
            overflow: hidden;
            position: absolute;
            top: 4px;
            bottom: 4px;
        }
        .timeline-clip:active { cursor: grabbing; }
        .timeline-clip.selected {
            box-shadow: 0 0 0 2px var(--accent-primary), 0 0 20px rgba(139, 92, 246, 0.5);
            z-index: 10;
        }
        .timeline-clip:hover { 
            transform: translateY(-2px); 
            filter: brightness(1.1);
            z-index: 5;
        }
        .timeline-clip.dragging {
            opacity: 0.7;
            z-index: 100;
        }
        
        .clip-content {
            height: 100%;
            display: flex;
            align-items: center;
            padding: 0 8px;
            gap: 6px;
            position: relative;
            overflow: hidden;
        }
        
        .clip-thumbnail {
            position: absolute;
            inset: 0;
            opacity: 0.2;
            background-size: cover;
            background-position: center;
        }
        
        .clip-name {
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            z-index: 1;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .clip-duration {
            font-size: 9px;
            opacity: 0.7;
            position: relative;
            z-index: 1;
        }
        
        .resize-handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 8px;
            cursor: ew-resize;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
            z-index: 20;
        }
        .resize-handle:hover, .timeline-clip:hover .resize-handle { 
            opacity: 1;
            background: rgba(139, 92, 246, 0.5);
        }
        .resize-handle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 20px;
            background: white;
            border-radius: 1px;
        }
        .resize-handle.left { left: 0; border-radius: 6px 0 0 6px; }
        .resize-handle.right { right: 0; border-radius: 0 6px 6px 0; }
        
        .transition-indicator {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 20px;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.4), transparent);
            z-index: 15;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .transition-indicator:hover {
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.7), transparent);
        }
        .transition-indicator.left { left: -10px; }
        .transition-indicator.right { right: -10px; }
        
        /* ===== PLAYHEAD ===== */
        .playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--error);
            z-index: 100;
            pointer-events: none;
        }
        .playhead::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -7px;
            width: 16px;
            height: 16px;
            background: var(--error);
            clip-path: polygon(50% 100%, 0 0, 100% 0);
        }
        .playhead::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -5px;
            width: 12px;
            height: 12px;
            background: var(--error);
            border-radius: 50%;
        }
        
        /* ===== TRACK STYLES ===== */
        .track-row {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }
        
        .track-label {
            min-width: 140px;
            width: 140px;
            background: linear-gradient(90deg, var(--bg-tertiary), var(--bg-secondary));
            display: flex;
            align-items: center;
            padding: 0 12px;
            gap: 8px;
            border-right: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .track-content {
            flex: 1;
            position: relative;
            background: var(--bg-primary);
            min-height: 100%;
        }
        
        .track-type-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .track-type-indicator.video { background: var(--accent-primary); }
        .track-type-indicator.audio { background: var(--success); }
        .track-type-indicator.text { background: var(--warning); }
        
        .track-name {
            font-size: 11px;
            font-weight: 500;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .track-controls {
            display: flex;
            gap: 4px;
        }
        
        .track-btn {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.15s;
        }
        .track-btn:hover { background: var(--bg-quaternary); color: var(--text-primary); }
        .track-btn.active { color: var(--accent-primary); }
        .track-btn.muted { color: var(--error); }
        
        /* ===== WAVEFORM ===== */
        .waveform-container {
            display: flex;
            align-items: center;
            gap: 1px;
            height: 100%;
            padding: 4px 0;
            overflow: hidden;
        }
        .waveform-bar {
            flex-shrink: 0;
            width: 2px;
            background: linear-gradient(180deg, #22c55e 0%, #16a34a 50%, #22c55e 100%);
            border-radius: 1px;
        }
        
        /* ===== KEYFRAMES ===== */
        .keyframe-track {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: rgba(0,0,0,0.3);
        }
        
        .keyframe-marker {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            width: 6px;
            height: 6px;
            background: #fbbf24;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            z-index: 15;
        }
        .keyframe-marker:hover { 
            transform: translate(-50%, -50%) rotate(45deg) scale(1.4);
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.6);
        }
        .keyframe-marker.selected {
            background: #f97316;
            box-shadow: 0 0 0 2px white;
        }
        
        /* ===== TOOL BUTTONS ===== */
        .tool-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s ease;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            gap: 6px;
        }
        .tool-btn:hover { 
            background: rgba(139, 92, 246, 0.15);
            color: var(--text-primary);
        }
        .tool-btn.active { 
            background: var(--accent-primary);
            color: white;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
        }
        .tool-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ===== PANELS ===== */
        .panel-section {
            background: var(--bg-tertiary);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        .panel-header {
            padding: 10px 14px;
            background: var(--bg-quaternary);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .panel-content {
            padding: 12px;
        }
        
        /* ===== TABS ===== */
        .tab-bar {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }
        .tab-btn {
            flex: 1;
            padding: 12px 8px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .tab-btn:hover { color: var(--text-primary); background: rgba(255,255,255,0.03); }
        .tab-btn.active { color: var(--accent-primary); }
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20%;
            right: 20%;
            height: 2px;
            background: var(--accent-primary);
            border-radius: 1px 1px 0 0;
        }
        .tab-btn svg {
            width: 18px;
            height: 18px;
        }
        
        /* ===== EFFECT CARDS ===== */
        .effect-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .effect-card {
            aspect-ratio: 1;
            background: var(--bg-quaternary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            border: 2px solid transparent;
            overflow: hidden;
        }
        .effect-card:hover { 
            background: #2f2f50; 
            transform: scale(1.05);
            border-color: rgba(139, 92, 246, 0.5);
        }
        .effect-card.active { 
            border-color: var(--accent-primary);
            background: rgba(139, 92, 246, 0.15);
        }
        .effect-preview {
            width: 100%;
            flex: 1;
            border-radius: 4px;
            margin-bottom: 6px;
        }
        .effect-name {
            font-size: 10px;
            text-align: center;
            color: var(--text-secondary);
        }
        
        /* ===== FILTER PREVIEWS ===== */
        .filter-original { background: linear-gradient(135deg, #667eea, #764ba2); }
        .filter-vintage { background: linear-gradient(135deg, #d4a574, #a67c52); filter: sepia(0.4); }
        .filter-bw { background: linear-gradient(135deg, #4a4a4a, #8a8a8a); }
        .filter-warm { background: linear-gradient(135deg, #ff9a56, #ff6b6b); }
        .filter-cool { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .filter-dramatic { background: linear-gradient(135deg, #1a1a2e, #4a1942); }
        .filter-fade { background: linear-gradient(135deg, #b8b8b8, #e0e0e0); }
        .filter-vivid { background: linear-gradient(135deg, #ff0844, #ffb199); }
        .filter-cinematic { background: linear-gradient(135deg, #1e3a5f, #d4956a); }
        .filter-noir { background: linear-gradient(135deg, #1a1a1a, #3a3a3a); }
        .filter-summer { background: linear-gradient(135deg, #f6d365, #fda085); }
        .filter-winter { background: linear-gradient(135deg, #a1c4fd, #c2e9fb); }
        
        /* ===== STICKERS ===== */
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .sticker-card {
            aspect-ratio: 1;
            background: var(--bg-quaternary);
            border-radius: 8px;
            cursor: grab;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 2px solid transparent;
        }
        .sticker-card:hover { 
            transform: scale(1.1); 
            border-color: var(--accent-primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .sticker-card:active { cursor: grabbing; }
        
        /* ===== SHAPES ===== */
        .shape-preview {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ===== TEMPLATES ===== */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .template-card {
            aspect-ratio: 9/16;
            background: var(--bg-quaternary);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
            position: relative;
        }
        .template-card:hover { 
            transform: scale(1.03);
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }
        .template-overlay {
            position: absolute;
            inset: 0;
            background: rgba(139, 92, 246, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .template-card:hover .template-overlay { opacity: 1; }
        .template-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 8px;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            font-size: 11px;
            font-weight: 500;
        }
        
        /* ===== AUDIO ITEMS ===== */
        .audio-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: var(--bg-quaternary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            margin-bottom: 8px;
        }
        .audio-item:hover { 
            background: #2f2f50;
            transform: translateX(4px);
        }
        .audio-play-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--success);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: transform 0.15s;
        }
        .audio-item:hover .audio-play-btn { transform: scale(1.1); }
        .audio-info { flex: 1; min-width: 0; }
        .audio-title { font-size: 13px; font-weight: 500; margin-bottom: 2px; }
        .audio-meta { font-size: 11px; color: var(--text-muted); }
        
        /* ===== MODALS ===== */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }
        .modal-backdrop.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: 0 24px 48px rgba(0,0,0,0.5);
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.95);
            transition: transform 0.2s;
        }
        .modal-backdrop.show .modal-content {
            transform: scale(1);
        }
        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal-title {
            font-size: 16px;
            font-weight: 600;
        }
        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .modal-close:hover { background: var(--bg-quaternary); }
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: 60vh;
        }
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* ===== FORM ELEMENTS ===== */
        .form-group {
            margin-bottom: 16px;
        }
        .form-label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }
        .form-input::placeholder { color: var(--text-muted); }
        
        .search-wrapper {
            position: relative;
        }
        .search-wrapper svg {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            color: var(--text-muted);
        }
        .search-wrapper .form-input {
            padding-left: 40px;
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: var(--bg-quaternary);
            border-radius: 3px;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 8px rgba(139, 92, 246, 0.5);
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        .range-with-value {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .range-with-value input[type="range"] {
            flex: 1;
        }
        .range-value {
            min-width: 40px;
            text-align: right;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent-primary);
            cursor: pointer;
        }
        
        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }
        .btn-secondary {
            background: var(--bg-quaternary);
            color: var(--text-primary);
        }
        .btn-secondary:hover {
            background: #2f2f50;
        }
        .btn-success {
            background: linear-gradient(135deg, var(--success), #10b981);
            color: white;
        }
        .btn-danger {
            background: var(--error);
            color: white;
        }
        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }
        .btn-ghost:hover {
            background: var(--bg-quaternary);
            color: var(--text-primary);
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        .btn-lg {
            padding: 14px 28px;
            font-size: 14px;
        }
        .btn-block {
            width: 100%;
        }
        
        /* ===== BADGES ===== */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .badge-ai {
            background: linear-gradient(135deg, #00d4ff, #7c3aed);
            color: white;
        }
        .badge-pro {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #000;
        }
        .badge-new {
            background: var(--success);
            color: white;
        }
        .badge-beta {
            background: var(--accent-secondary);
            color: white;
        }
        
        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .toast {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            min-width: 300px;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--error); }
        .toast.warning { border-left: 4px solid var(--warning); }
        .toast.info { border-left: 4px solid var(--accent-primary); }
        .toast-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        .toast-message {
            flex: 1;
            font-size: 13px;
        }
        .toast-close {
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.15s;
        }
        .toast-close:hover { opacity: 1; }
        
        /* ===== CONTEXT MENU ===== */
        .context-menu {
            position: fixed;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 6px;
            min-width: 200px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            z-index: 1500;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.95);
            transition: all 0.1s ease;
        }
        .context-menu.show {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
        }
        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.1s;
            color: var(--text-primary);
        }
        .context-menu-item:hover {
            background: var(--accent-primary);
        }
        .context-menu-item.danger:hover {
            background: var(--error);
        }
        .context-menu-item svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }
        .context-menu-item .shortcut {
            margin-left: auto;
            font-size: 11px;
            color: var(--text-muted);
        }
        .context-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 6px 0;
        }
        
        /* ===== PROGRESS ===== */
        .progress-bar {
            height: 6px;
            background: var(--bg-quaternary);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transition: width 0.3s ease;
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring-circle {
            transition: stroke-dashoffset 0.3s;
            stroke-linecap: round;
        }
        
        /* ===== SPINNER ===== */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--bg-quaternary);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .spinner-sm { width: 16px; height: 16px; border-width: 2px; }
        .spinner-lg { width: 32px; height: 32px; border-width: 4px; }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ===== SKELETON LOADING ===== */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-quaternary) 25%, var(--bg-tertiary) 50%, var(--bg-quaternary) 75%);
            background-size: 200% 100%;
            animation: skeleton 1.5s infinite;
            border-radius: 4px;
        }
        @keyframes skeleton {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* ===== DROPDOWN ===== */
        .dropdown {
            position: relative;
        }
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 6px;
            min-width: 180px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.15s;
        }
        .dropdown:hover .dropdown-menu,
        .dropdown.open .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.1s;
        }
        .dropdown-item:hover {
            background: var(--accent-primary);
        }
        
        /* ===== GRADIENTS ===== */
        .gradient-purple { background: linear-gradient(135deg, #8b5cf6, #ec4899); }
        .gradient-blue { background: linear-gradient(135deg, #3b82f6, #06b6d4); }
        .gradient-green { background: linear-gradient(135deg, #22c55e, #10b981); }
        .gradient-orange { background: linear-gradient(135deg, #f59e0b, #ef4444); }
        .gradient-pink { background: linear-gradient(135deg, #ec4899, #f43f5e); }
        .gradient-teal { background: linear-gradient(135deg, #14b8a6, #06b6d4); }
        
        /* ===== UTILITIES ===== */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: 4px; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .gap-4 { gap: 16px; }
        .flex-1 { flex: 1; }
        .shrink-0 { flex-shrink: 0; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .text-center { text-align: center; }
        .text-sm { font-size: 12px; }
        .text-xs { font-size: 11px; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .opacity-50 { opacity: 0.5; }
        .opacity-70 { opacity: 0.7; }
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .rounded { border-radius: 8px; }
        .rounded-lg { border-radius: 12px; }
        .rounded-full { border-radius: 9999px; }
        .overflow-hidden { overflow: hidden; }
        .overflow-auto { overflow: auto; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .inset-0 { inset: 0; }
        .hidden { display: none !important; }
        
        .text-muted { color: var(--text-muted); }
        .text-secondary { color: var(--text-secondary); }
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-error { color: var(--error); }
        .text-accent { color: var(--accent-primary); }
        
        .bg-dark { background: var(--bg-primary); }
        .bg-darker { background: #050508; }
        
        .border-b { border-bottom: 1px solid var(--border-color); }
        .border-t { border-top: 1px solid var(--border-color); }
        .border-l { border-left: 1px solid var(--border-color); }
        .border-r { border-right: 1px solid var(--border-color); }
        
        .p-2 { padding: 8px; }
        .p-3 { padding: 12px; }
        .p-4 { padding: 16px; }
        .px-2 { padding-left: 8px; padding-right: 8px; }
        .px-3 { padding-left: 12px; padding-right: 12px; }
        .px-4 { padding-left: 16px; padding-right: 16px; }
        .py-2 { padding-top: 8px; padding-bottom: 8px; }
        .py-3 { padding-top: 12px; padding-bottom: 12px; }
        .py-4 { padding-top: 16px; padding-bottom: 16px; }
        
        .m-0 { margin: 0; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-4 { margin-bottom: 16px; }
        .mt-2 { margin-top: 8px; }
        .mt-3 { margin-top: 12px; }
        .mt-4 { margin-top: 16px; }
        
        .cursor-pointer { cursor: pointer; }
        .select-none { user-select: none; }
        .pointer-events-none { pointer-events: none; }
        
        /* Transition Preview Styles */
        .transition-preview {
            position: relative;
            height: 28px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
        }
        .transition-preview::before,
        .transition-preview::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 50%;
        }
        .transition-preview::before {
            left: 0;
            background: var(--accent-primary);
        }
        .transition-preview::after {
            right: 0;
            background: var(--accent-secondary);
        }
        .transition-dissolve::before {
            background: linear-gradient(90deg, var(--accent-primary), transparent);
        }
        .transition-wipe::before {
            clip-path: polygon(0 0, 100% 0, 80% 100%, 0 100%);
        }
        .transition-slide::before {
            animation: slideAnim 1s ease-in-out infinite alternate;
        }
        @keyframes slideAnim {
            from { transform: translateX(0); }
            to { transform: translateX(20%); }
        }
        .transition-zoom::before {
            width: 30%;
            height: 60%;
            top: 20%;
            left: 35%;
            border-radius: 50%;
        }
        .transition-blur::before,
        .transition-blur::after {
            filter: blur(4px);
        }
        /* ===== ADVANCED FEATURES CSS ===== */

/* Video Thumbnails */
.video-thumbnail {
    position: relative;
    overflow: hidden;
}
.video-thumbnail video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.video-thumbnail .duration-badge {
    position: absolute;
    bottom: 4px;
    right: 4px;
    background: rgba(0,0,0,0.8);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
}

/* Loading Overlay */
.loading-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}
.loading-overlay .loading-text {
    font-size: 18px;
    font-weight: 500;
    margin-bottom: 8px;
}
.loading-overlay .loading-detail {
    font-size: 14px;
    color: var(--text-muted);
}

/* Chroma Key Preview */
.chroma-preview {
    width: 100%;
    height: 60px;
    background: repeating-conic-gradient(#808080 0% 25%, transparent 0% 50%) 50% / 20px 20px;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
}

/* Histogram */
.histogram {
    height: 60px;
    background: var(--bg-quaternary);
    border-radius: 8px;
    padding: 8px;
    display: flex;
    align-items: flex-end;
    gap: 1px;
}
.histogram-bar {
    flex: 1;
    background: linear-gradient(to top, var(--accent-primary), var(--accent-secondary));
    border-radius: 2px 2px 0 0;
    min-height: 2px;
}

/* Audio Meter */
.audio-meter {
    width: 100%;
    height: 8px;
    background: var(--bg-quaternary);
    border-radius: 4px;
    overflow: hidden;
}
.audio-meter-fill {
    height: 100%;
    background: linear-gradient(to right, #22c55e, #fbbf24, #ef4444);
    transition: width 0.1s;
}

/* Bezier Editor */
.bezier-editor {
    width: 120px;
    height: 120px;
    background: var(--bg-quaternary);
    border-radius: 8px;
    position: relative;
}
.bezier-editor svg {
    width: 100%;
    height: 100%;
}
.bezier-editor .control-point {
    fill: var(--accent-primary);
    cursor: grab;
}
.bezier-editor .curve-path {
    stroke: var(--accent-primary);
    stroke-width: 2;
    fill: none;
}
.bezier-editor .control-line {
    stroke: var(--text-muted);
    stroke-width: 1;
    stroke-dasharray: 4 2;
}

/* Layer Item */
.layer-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    background: var(--bg-quaternary);
    border-radius: 8px;
    margin-bottom: 4px;
    cursor: grab;
    transition: all 0.15s;
}
.layer-item:hover {
    background: #2f2f50;
}
.layer-item.selected {
    background: rgba(139, 92, 246, 0.2);
    border: 1px solid var(--accent-primary);
}
.layer-thumbnail {
    width: 40px;
    height: 24px;
    background: var(--bg-secondary);
    border-radius: 4px;
}
.layer-name {
    flex: 1;
    font-size: 12px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Timeline Marker */
.timeline-marker {
    position: absolute;
    top: 0;
    width: 2px;
    background: #fbbf24;
    z-index: 50;
    cursor: pointer;
}
.timeline-marker::before {
    content: '';
    position: absolute;
    top: 0;
    left: -5px;
    width: 12px;
    height: 12px;
    background: #fbbf24;
    border-radius: 50% 50% 50% 0;
    transform: rotate(-45deg);
}

/* Color Wheel */
.color-wheel {
    aspect-ratio: 1;
    border-radius: 50%;
    background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red);
    padding: 3px;
    cursor: crosshair;
}
.color-wheel-inner {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: radial-gradient(circle, white, transparent);
    display: flex;
    align-items: center;
    justify-content: center;
}
.color-wheel-pointer {
    width: 10px;
    height: 10px;
    background: white;
    border: 2px solid #333;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}
    </style>
    <!-- Add these AFTER the existing Tailwind and Fabric.js scripts -->
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/umd/ffmpeg.js"></script>
<script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
<script src="https://unpkg.com/wavesurfer.js@7"></script>
</head>
<body class="select-none">
    <div id="app" class="h-screen flex flex-col">
        <!-- ========== TOP HEADER ========== -->
        <header class="h-14 bg-[#0d0d18] border-b flex items-center px-4 justify-between shrink-0">
            <!-- Left: Logo & File Menu -->
            <div class="flex items-center gap-4">
                <!-- Logo -->
                <div class="flex items-center gap-2">
                    <div class="w-9 h-9 rounded-xl flex items-center justify-center font-bold text-lg gradient-purple shadow-lg">F</div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-lg">FlowCut</span>
                        <span class="badge badge-pro">PRO</span>
                    </div>
                </div>
                
                <div class="h-8 w-px bg-gray-800"></div>
                
                <!-- File Menu -->
                <div class="flex gap-1">
                    <div class="dropdown">
                        <button class="tool-btn">File</button>
                        <div class="dropdown-menu">
                            <div class="dropdown-item" onclick="newProject()">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                New Project
                                <span class="shortcut">Ctrl+N</span>
                            </div>
                            <div class="dropdown-item" onclick="openProject()">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"/></svg>
                                Open Project
                                <span class="shortcut">Ctrl+O</span>
                            </div>
                            <div class="context-menu-divider"></div>
                            <div class="dropdown-item" onclick="saveProject()">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                                Save
                                <span class="shortcut">Ctrl+S</span>
                            </div>
                            <div class="dropdown-item" onclick="saveProjectAs()">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                                Save As...
                            </div>
                            <div class="context-menu-divider"></div>
                            <div class="dropdown-item" onclick="showExportModal()">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                                Export Video
                                <span class="shortcut">Ctrl+E</span>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="tool-btn">Edit</button>
                        <div class="dropdown-menu">
                            <div class="dropdown-item" onclick="undo()">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>
                                Undo
                                <span class="shortcut">Ctrl+Z</span>
                            </div>
                            <div class="dropdown-item" onclick="redo()">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6"/></svg>
                                Redo
                                <span class="shortcut">Ctrl+Y</span>
                            </div>
                            <div class="context-menu-divider"></div>
                            <div class="dropdown-item" onclick="cutClip()">Cut <span class="shortcut">Ctrl+X</span></div>
                            <div class="dropdown-item" onclick="copyClip()">Copy <span class="shortcut">Ctrl+C</span></div>
                            <div class="dropdown-item" onclick="pasteClip()">Paste <span class="shortcut">Ctrl+V</span></div>
                            <div class="dropdown-item" onclick="deleteSelected()">Delete <span class="shortcut">Del</span></div>
                            <div class="context-menu-divider"></div>
                            <div class="dropdown-item" onclick="selectAll()">Select All <span class="shortcut">Ctrl+A</span></div>
                            <div class="dropdown-item" onclick="deselectAll()">Deselect All</div>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="tool-btn">View</button>
                        <div class="dropdown-menu">
                            <div class="dropdown-item" onclick="toggleSafeZones()">
                                <span id="safeZoneCheck">✓</span> Safe Zones
                            </div>
                            <div class="dropdown-item" onclick="toggleGrid()">
                                <span id="gridCheck">✓</span> Grid Overlay
                            </div>
                            <div class="context-menu-divider"></div>
                            <div class="dropdown-item" onclick="zoomToFit()">Zoom to Fit</div>
                            <div class="dropdown-item" onclick="zoom100()">100% Zoom</div>
                            <div class="context-menu-divider"></div>
                            <div class="dropdown-item" onclick="toggleFullscreen()">Fullscreen Preview</div>
                        </div>
                    </div>
                </div>
                
                <div class="h-8 w-px bg-gray-800"></div>
                
                <!-- Undo/Redo Buttons -->
                <div class="flex gap-1">
                    <button class="tool-btn" onclick="undo()" title="Undo (Ctrl+Z)" id="undoBtn">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>
                    </button>
                    <button class="tool-btn" onclick="redo()" title="Redo (Ctrl+Y)" id="redoBtn">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6"/></svg>
                    </button>
                </div>
            </div>
            
            <!-- Center: Project Name -->
            <div class="flex items-center gap-3">
                <input type="text" id="projectName" value="Untitled Project" 
                    class="bg-transparent text-center font-medium text-sm border-b border-transparent hover:border-gray-600 focus:border-purple-500 focus:outline-none px-3 py-1 w-56 transition">
                <span class="text-xs text-muted" id="saveStatus">
                    <span class="text-success">●</span> Saved
                </span>
            </div>
            
            <!-- Right: Preview Quality & Export -->
            <div class="flex items-center gap-3">
                <select class="form-select py-1.5 px-3 text-xs w-32" id="previewQuality" onchange="setPreviewQuality(this.value)">
                    <option value="full">Full Quality</option>
                    <option value="half" selected>Half Quality</option>
                    <option value="quarter">Quarter Quality</option>
                </select>
                
                <button class="btn btn-primary" onclick="showExportModal()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    Export
                </button>
            </div>
        </header>

        <!-- ========== MAIN CONTENT ========== -->
        <div class="flex-1 flex overflow-hidden">
            <!-- ===== LEFT SIDEBAR ===== -->
            <aside class="w-72 bg-[#0d0d18] border-r flex flex-col shrink-0">
                <!-- Tabs -->
                <div class="tab-bar">
                    <button class="tab-btn active" data-panel="media" onclick="switchPanel('media')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                        Media
                    </button>
                    <button class="tab-btn" data-panel="text" onclick="switchPanel('text')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                        Text
                    </button>
                    <button class="tab-btn" data-panel="elements" onclick="switchPanel('elements')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Elements
                    </button>
                    <button class="tab-btn" data-panel="effects" onclick="switchPanel('effects')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/></svg>
                        Effects
                    </button>
                    <button class="tab-btn" data-panel="audio" onclick="switchPanel('audio')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg>
                        Audio
                    </button>
    <button class="tab-btn active" data-panel="media" onclick="switchPanel('media')">...</button>
    <button class="tab-btn" data-panel="text" onclick="switchPanel('text')">...</button>
    <button class="tab-btn" data-panel="elements" onclick="switchPanel('elements')">...</button>
    <button class="tab-btn" data-panel="effects" onclick="switchPanel('effects')">...</button>
    <button class="tab-btn" data-panel="audio" onclick="switchPanel('audio')">...</button>
                </div>
                
                <!-- Panel Content -->
                <div class="flex-1 overflow-y-auto p-3">
                    <!-- MEDIA PANEL -->
                    <div id="panel-media" class="panel-container">
                        <!-- Import Area -->
                        <div class="border-2 border-dashed border-gray-700 rounded-xl p-6 text-center hover:border-purple-500 hover:bg-purple-500/5 transition cursor-pointer mb-4 group"
                             onclick="document.getElementById('fileInput').click()"
                             ondragover="handleDragOver(event)" ondrop="handleFileDrop(event)">
                            <div class="w-14 h-14 mx-auto mb-3 rounded-full bg-purple-500/10 flex items-center justify-center group-hover:bg-purple-500/20 transition">
                                <svg class="w-7 h-7 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                            </div>
                            <p class="text-sm font-medium mb-1">Import Media</p>
                            <p class="text-xs text-muted">Drag & drop or click to browse</p>
                            <input type="file" id="fileInput" class="hidden" multiple accept="video/*,audio/*,image/*" onchange="handleFileImport(event)">
                        </div>
                        
                        <!-- Templates Section -->
                        <div class="panel-section">
                            <div class="panel-header">
                                <span>Templates</span>
                                <span class="badge badge-new">New</span>
                            </div>
                            <div class="panel-content">
                                <div class="template-grid">
                                    <div class="template-card gradient-purple" onclick="loadTemplate('intro')">
                                        <div class="template-overlay">Use Template</div>
                                        <div class="template-name">Intro</div>
                                    </div>
                                    <div class="template-card gradient-blue" onclick="loadTemplate('outro')">
                                        <div class="template-overlay">Use Template</div>
                                        <div class="template-name">Outro</div>
                                    </div>
                                    <div class="template-card gradient-green" onclick="loadTemplate('social')">
                                        <div class="template-overlay">Use Template</div>
                                        <div class="template-name">Social</div>
                                    </div>
                                    <div class="template-card gradient-orange" onclick="loadTemplate('promo')">
                                        <div class="template-overlay">Use Template</div>
                                        <div class="template-name">Promo</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- My Media Section -->
                        <div class="panel-section">
                            <div class="panel-header">
                                <span>My Media</span>
                                <span class="text-xs text-muted" id="mediaCount">0 items</span>
                            </div>
                            <div class="panel-content">
                                <div id="mediaLibrary" class="grid grid-cols-2 gap-2">
                                    <div class="text-center py-8 col-span-2 text-muted text-sm">
                                        <svg class="w-12 h-12 mx-auto mb-2 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                        No media imported yet
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- TEXT PANEL -->
                    <div id="panel-text" class="panel-container hidden">
                        <button class="btn btn-primary btn-block btn-lg mb-4" onclick="addText()">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            Add Text
                        </button>
                        
                        <!-- Text Templates -->
                        <div class="panel-section">
                            <div class="panel-header">Text Templates</div>
                            <div class="panel-content space-y-2">
                                <div class="p-3 bg-[#252540] rounded-lg cursor-pointer hover:bg-[#2f2f50] transition group" onclick="addTextStyle('title')">
                                    <div class="text-2xl font-bold mb-1 group-hover:text-purple-400 transition">Title</div>
                                    <div class="text-xs text-muted">Large centered heading</div>
                                </div>
                                <div class="p-3 bg-[#252540] rounded-lg cursor-pointer hover:bg-[#2f2f50] transition group" onclick="addTextStyle('subtitle')">
                                    <div class="text-lg font-semibold mb-1 group-hover:text-purple-400 transition">Subtitle</div>
                                    <div class="text-xs text-muted">Secondary heading</div>
                                </div>
                                <div class="p-3 bg-[#252540] rounded-lg cursor-pointer hover:bg-[#2f2f50] transition group" onclick="addTextStyle('body')">
                                    <div class="text-sm mb-1 group-hover:text-purple-400 transition">Body Text</div>
                                    <div class="text-xs text-muted">Paragraph text</div>
                                </div>
                                <div class="p-3 bg-[#252540] rounded-lg cursor-pointer hover:bg-[#2f2f50] transition group" onclick="addTextStyle('caption')">
                                    <div class="text-xs mb-1 group-hover:text-purple-400 transition">Caption</div>
                                    <div class="text-xs text-muted">Subtitle captions</div>
                                </div>
                                <div class="p-3 bg-[#252540] rounded-lg cursor-pointer hover:bg-[#2f2f50] transition group" onclick="addTextStyle('lowerThird')">
                                    <div class="flex items-end gap-2 mb-1">
                                        <div class="w-1 h-6 bg-purple-500 rounded"></div>
                                        <div>
                                            <div class="text-sm font-semibold group-hover:text-purple-400 transition">Name Here</div>
                                            <div class="text-xs text-muted">Title / Role</div>
                                        </div>
                                    </div>
                                    <div class="text-xs text-muted">Lower third template</div>
                                </div>
                            </div>
                        </div>
                        <!-- Find this section and add the new "Advanced" tab -->

    
    <!-- ADD THIS NEW TAB -->
    <button class="tab-btn" data-panel="advanced" onclick="switchPanel('advanced')">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        Advanced
    </button>
</div>
                        <!-- Text Animations -->
                        <div class="panel-section">
                            <div class="panel-header">Text Animations</div>
                            <div class="panel-content grid grid-cols-2 gap-2">
                                <button class="btn btn-secondary btn-sm" onclick="addTextAnimation('fadeIn')">Fade In</button>
                                <button class="btn btn-secondary btn-sm" onclick="addTextAnimation('typewriter')">Typewriter</button>
                                <button class="btn btn-secondary btn-sm" onclick="addTextAnimation('bounce')">Bounce</button>
                                <button class="btn btn-secondary btn-sm" onclick="addTextAnimation('slideUp')">Slide Up</button>
                                <button class="btn btn-secondary btn-sm" onclick="addTextAnimation('slideDown')">Slide Down</button>
                                <button class="btn btn-secondary btn-sm" onclick="addTextAnimation('zoomIn')">Zoom In</button>
                                <button class="btn btn-secondary btn-sm" onclick="addTextAnimation('shake')">Shake</button>
                                <button class="btn btn-secondary btn-sm" onclick="addTextAnimation('glitch')">Glitch</button>
                            </div>
                        </div>
                        
                        <!-- Auto Captions -->
                        <div class="panel-section">
                            <div class="panel-header">
                                <span>Auto Captions</span>
                                <span class="badge badge-ai">AI</span>
                            </div>
                            <div class="panel-content">
                                <p class="text-xs text-muted mb-3">Automatically generate captions from your video's audio track</p>
                                <button class="btn btn-block gradient-blue text-white" onclick="generateCaptions()">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/></svg>
                                    Generate Captions
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ELEMENTS PANEL -->
                    <div id="panel-elements" class="panel-container hidden">
                        <!-- Stickers -->
                        <div class="panel-section">
                            <div class="panel-header">
                                <span>Stickers</span>
                                <button class="text-xs text-accent hover:underline">See All</button>
                            </div>
                            <div class="panel-content">
                                <div class="search-wrapper mb-3">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                    <input type="text" class="form-input" placeholder="Search stickers..." id="stickerSearch" oninput="filterStickers(this.value)">
                                </div>
                                <div class="sticker-grid" id="stickersGrid">
                                    <div class="sticker-card" draggable="true" ondragstart="dragElement(event, 'sticker', '😀')">😀</div>
                                    <div class="sticker-card" draggable="true" ondragstart="dragElement(event, 'sticker', '🎉')">🎉</div>
                                    <div class="sticker-card" draggable="true" ondragstart="dragElement(event, 'sticker', '❤️')">❤️</div>
                                    <div class="sticker-card" draggable="true" ondragstart="dragElement(event, 'sticker', '🔥')">🔥</div>
                                    <div class="sticker-card" draggable="true" ondragstart="dragElement(event, 'sticker', '⭐')">⭐</div>
                                    <div class="sticker-card" draggable="true" ondragstart="dragElement(event, 'sticker', '👍')">👍</div>
                                    <div class="sticker-card" draggable="true" ondragstart="dragElement(event, 'sticker', '💯')">💯</div>
                                    <div class="sticker-card" draggable="true" ondragstart="dragElement(event, 'sticker', '✨')">✨</div>
                                    <div class="sticker-card" draggable="true" ondragstart="dragElement(event, 'sticker', '🎵')">🎵</div>
                                    <div class="sticker-card" draggable="true" ondragstart="dragElement(event, 'sticker', '💬')">💬</div>
                                    <div class="sticker-card" draggable="true" ondragstart="dragElement(event, 'sticker', '📍')">📍</div>
                                    <div class="sticker-card" draggable="true" ondragstart="dragElement(event, 'sticker', '🎯')">🎯</div>
                                    <div class="sticker-card" draggable="true" ondragstart="dragElement(event, 'sticker', '🚀')">🚀</div>
                                    <div class="sticker-card" draggable="true" ondragstart="dragElement(event, 'sticker', '💡')">💡</div>
                                    <div class="sticker-card" draggable="true" ondragstart="dragElement(event, 'sticker', '🎬')">🎬</div>
                                    <div class="sticker-card" draggable="true" ondragstart="dragElement(event, 'sticker', '📸')">📸</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Shapes -->
                        <div class="panel-section">
                            <div class="panel-header">Shapes</div>
                            <div class="panel-content">
                                <div class="sticker-grid">
                                    <div class="sticker-card shape-preview" onclick="addShape('rectangle')">
                                        <div class="w-7 h-5 bg-white rounded-sm"></div>
                                    </div>
                                    <div class="sticker-card shape-preview" onclick="addShape('circle')">
                                        <div class="w-6 h-6 bg-white rounded-full"></div>
                                    </div>
                                    <div class="sticker-card shape-preview" onclick="addShape('triangle')">
                                        <div class="w-0 h-0 border-l-[12px] border-r-[12px] border-b-[20px] border-l-transparent border-r-transparent border-b-white"></div>
                                    </div>
                                    <div class="sticker-card shape-preview" onclick="addShape('star')">
                                        <span class="text-white text-2xl">★</span>
                                    </div>
                                    <div class="sticker-card shape-preview" onclick="addShape('arrow')">
                                        <span class="text-white text-2xl">→</span>
                                    </div>
                                    <div class="sticker-card shape-preview" onclick="addShape('line')">
                                        <div class="w-8 h-0.5 bg-white"></div>
                                    </div>
                                    <div class="sticker-card shape-preview" onclick="addShape('hexagon')">
                                        <span class="text-white text-2xl">⬡</span>
                                    </div>
                                    <div class="sticker-card shape-preview" onclick="addShape('diamond')">
                                        <div class="w-5 h-5 bg-white rotate-45"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Overlays -->
                        <div class="panel-section">
                            <div class="panel-header">Overlays</div>
                            <div class="panel-content grid grid-cols-2 gap-2">
                                <div class="aspect-video rounded-lg cursor-pointer hover:ring-2 ring-purple-500 transition overflow-hidden" onclick="addOverlay('vignette')">
                                    <div class="w-full h-full bg-gradient-to-b from-transparent via-transparent to-black"></div>
                                </div>
                                <div class="aspect-video rounded-lg cursor-pointer hover:ring-2 ring-purple-500 transition overflow-hidden" onclick="addOverlay('scanlines')" style="background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,0.03) 2px, rgba(255,255,255,0.03) 4px)"></div>
                                <div class="aspect-video rounded-lg cursor-pointer hover:ring-2 ring-purple-500 transition overflow-hidden" onclick="addOverlay('chromatic')">
                                    <div class="w-full h-full bg-gradient-to-r from-red-500/20 via-transparent to-blue-500/20"></div>
                                </div>
                                <div class="aspect-video rounded-lg cursor-pointer hover:ring-2 ring-purple-500 transition overflow-hidden" onclick="addOverlay('grain')" style="background: repeating-radial-gradient(circle at 50% 50%, transparent 0, rgba(255,255,255,0.05) 1px, transparent 2px), #252540"></div>
                                <div class="aspect-video rounded-lg cursor-pointer hover:ring-2 ring-purple-500 transition overflow-hidden" onclick="addOverlay('letterbox')">
                                    <div class="w-full h-full flex flex-col">
                                        <div class="h-3 bg-black"></div>
                                        <div class="flex-1 bg-gray-600"></div>
                                        <div class="h-3 bg-black"></div>
                                    </div>
                                </div>
                                <div class="aspect-video rounded-lg cursor-pointer hover:ring-2 ring-purple-500 transition overflow-hidden" onclick="addOverlay('light-leak')">
                                    <div class="w-full h-full bg-gradient-to-br from-orange-500/30 via-transparent to-pink-500/20"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- EFFECTS PANEL -->
                    <div id="panel-effects" class="panel-container hidden">
                        <!-- Filters -->
                        <div class="panel-section">
                            <div class="panel-header">Filters</div>
                            <div class="panel-content">
                                <div class="effect-grid">
                                    <div class="effect-card" onclick="applyFilter('none')" data-filter="none">
                                        <div class="effect-preview filter-original"></div>
                                        <span class="effect-name">Original</span>
                                    </div>
                                    <div class="effect-card" onclick="applyFilter('vintage')" data-filter="vintage">
                                        <div class="effect-preview filter-vintage"></div>
                                        <span class="effect-name">Vintage</span>
                                    </div>
                                    <div class="effect-card" onclick="applyFilter('bw')" data-filter="bw">
                                        <div class="effect-preview filter
                                                                                <div class="effect-preview filter-bw"></div>
                                        <span class="effect-name">B&W</span>
                                    </div>
                                    <div class="effect-card" onclick="applyFilter('warm')" data-filter="warm">
                                        <div class="effect-preview filter-warm"></div>
                                        <span class="effect-name">Warm</span>
                                    </div>
                                    <div class="effect-card" onclick="applyFilter('cool')" data-filter="cool">
                                        <div class="effect-preview filter-cool"></div>
                                        <span class="effect-name">Cool</span>
                                    </div>
                                    <div class="effect-card" onclick="applyFilter('dramatic')" data-filter="dramatic">
                                        <div class="effect-preview filter-dramatic"></div>
                                        <span class="effect-name">Dramatic</span>
                                    </div>
                                    <div class="effect-card" onclick="applyFilter('fade')" data-filter="fade">
                                        <div class="effect-preview filter-fade"></div>
                                        <span class="effect-name">Fade</span>
                                    </div>
                                    <div class="effect-card" onclick="applyFilter('vivid')" data-filter="vivid">
                                        <div class="effect-preview filter-vivid"></div>
                                        <span class="effect-name">Vivid</span>
                                    </div>
                                    <div class="effect-card" onclick="applyFilter('cinematic')" data-filter="cinematic">
                                        <div class="effect-preview filter-cinematic"></div>
                                        <span class="effect-name">Cinematic</span>
                                    </div>
                                    <div class="effect-card" onclick="applyFilter('noir')" data-filter="noir">
                                        <div class="effect-preview filter-noir"></div>
                                        <span class="effect-name">Noir</span>
                                    </div>
                                    <div class="effect-card" onclick="applyFilter('summer')" data-filter="summer">
                                        <div class="effect-preview filter-summer"></div>
                                        <span class="effect-name">Summer</span>
                                    </div>
                                    <div class="effect-card" onclick="applyFilter('winter')" data-filter="winter">
                                        <div class="effect-preview filter-winter"></div>
                                        <span class="effect-name">Winter</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Color Adjustments -->
                        <div class="panel-section">
                            <div class="panel-header">
                                <span>Color Adjustments</span>
                                <button class="text-xs text-accent" onclick="resetColorAdjustments()">Reset</button>
                            </div>
                            <div class="panel-content space-y-4">
                                <div class="form-group m-0">
                                    <label class="form-label flex justify-between">
                                        <span>Brightness</span>
                                        <span id="brightnessValue">0</span>
                                    </label>
                                    <input type="range" min="-100" max="100" value="0" id="brightness" oninput="updateAdjustment('brightness', this.value)">
                                </div>
                                <div class="form-group m-0">
                                    <label class="form-label flex justify-between">
                                        <span>Contrast</span>
                                        <span id="contrastValue">0</span>
                                    </label>
                                    <input type="range" min="-100" max="100" value="0" id="contrast" oninput="updateAdjustment('contrast', this.value)">
                                </div>
                                <div class="form-group m-0">
                                    <label class="form-label flex justify-between">
                                        <span>Saturation</span>
                                        <span id="saturationValue">0</span>
                                    </label>
                                    <input type="range" min="-100" max="100" value="0" id="saturation" oninput="updateAdjustment('saturation', this.value)">
                                </div>
                                <div class="form-group m-0">
                                    <label class="form-label flex justify-between">
                                        <span>Temperature</span>
                                        <span id="temperatureValue">0</span>
                                    </label>
                                    <input type="range" min="-100" max="100" value="0" id="temperature" oninput="updateAdjustment('temperature', this.value)">
                                </div>
                                <div class="form-group m-0">
                                    <label class="form-label flex justify-between">
                                        <span>Vignette</span>
                                        <span id="vignetteValue">0</span>
                                    </label>
                                    <input type="range" min="0" max="100" value="0" id="vignette" oninput="updateAdjustment('vignette', this.value)">
                                </div>
                                <div class="form-group m-0">
                                    <label class="form-label flex justify-between">
                                        <span>Blur</span>
                                        <span id="blurValue">0</span>
                                    </label>
                                    <input type="range" min="0" max="20" value="0" id="blur" oninput="updateAdjustment('blur', this.value)">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Video Effects -->
                        <div class="panel-section">
                            <div class="panel-header">Video Effects</div>
                            <div class="panel-content grid grid-cols-2 gap-2">
                                <button class="btn btn-secondary btn-sm" onclick="addEffect('blur')">🌫️ Blur</button>
                                <button class="btn btn-secondary btn-sm" onclick="addEffect('glitch')">📺 Glitch</button>
                                <button class="btn btn-secondary btn-sm" onclick="addEffect('vhs')">📼 VHS</button>
                                <button class="btn btn-secondary btn-sm" onclick="addEffect('shake')">📳 Shake</button>
                                <button class="btn btn-secondary btn-sm" onclick="addEffect('zoom')">🔍 Zoom</button>
                                <button class="btn btn-secondary btn-sm" onclick="addEffect('flash')">⚡ Flash</button>
                                <button class="btn btn-secondary btn-sm" onclick="addEffect('rotate')">🔄 Rotate</button>
                                <button class="btn btn-secondary btn-sm" onclick="addEffect('mirror')">🪞 Mirror</button>
                            </div>
                        </div>
                        
                        <!-- Transitions -->
                        <div class="panel-section">
                            <div class="panel-header">Transitions</div>
                            <div class="panel-content grid grid-cols-2 gap-2">
                                <div class="p-2 bg-[#252540] rounded-lg cursor-pointer hover:bg-[#2f2f50] transition" onclick="selectTransition('dissolve')">
                                    <div class="transition-preview transition-dissolve mb-2"></div>
                                    <span class="text-xs">Dissolve</span>
                                </div>
                                <div class="p-2 bg-[#252540] rounded-lg cursor-pointer hover:bg-[#2f2f50] transition" onclick="selectTransition('wipe')">
                                    <div class="transition-preview transition-wipe mb-2"></div>
                                    <span class="text-xs">Wipe</span>
                                </div>
                                <div class="p-2 bg-[#252540] rounded-lg cursor-pointer hover:bg-[#2f2f50] transition" onclick="selectTransition('slide')">
                                    <div class="transition-preview transition-slide mb-2"></div>
                                    <span class="text-xs">Slide</span>
                                </div>
                                <div class="p-2 bg-[#252540] rounded-lg cursor-pointer hover:bg-[#2f2f50] transition" onclick="selectTransition('zoom')">
                                    <div class="transition-preview transition-zoom mb-2"></div>
                                    <span class="text-xs">Zoom</span>
                                </div>
                                <div class="p-2 bg-[#252540] rounded-lg cursor-pointer hover:bg-[#2f2f50] transition" onclick="selectTransition('fade')">
                                    <div class="transition-preview mb-2" style="background: linear-gradient(90deg, var(--accent-primary), #000, var(--accent-secondary))"></div>
                                    <span class="text-xs">Fade Black</span>
                                </div>
                                <div class="p-2 bg-[#252540] rounded-lg cursor-pointer hover:bg-[#2f2f50] transition" onclick="selectTransition('blur')">
                                    <div class="transition-preview transition-blur mb-2"></div>
                                    <span class="text-xs">Blur</span>
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="form-label">Transition Duration: <span id="transitionDurationValue">0.5s</span></label>
                                <input type="range" min="0.1" max="2" step="0.1" value="0.5" id="transitionDuration" oninput="document.getElementById('transitionDurationValue').textContent = this.value + 's'">
                            </div>
                        </div>
                        
                        <!-- AI Effects -->
                        <div class="panel-section">
                            <div class="panel-header">
                                <span>AI Effects</span>
                                <span class="badge badge-ai">AI</span>
                            </div>
                            <div class="panel-content space-y-2">
                                <button class="btn btn-block gradient-blue text-white" onclick="removeBackground()">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                                    Remove Background
                                </button>
                                <button class="btn btn-block bg-gradient-to-r from-green-500 to-teal-500 text-white" onclick="autoReframe()">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
                                    Auto Reframe
                                </button>
                                <button class="btn btn-block bg-gradient-to-r from-purple-500 to-pink-500 text-white" onclick="stabilizeVideo()">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                    Stabilize Video
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AUDIO PANEL -->
                    <div id="panel-audio" class="panel-container hidden">
                        <button class="btn btn-success btn-block btn-lg mb-4" onclick="document.getElementById('audioInput').click()">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            Import Audio
                            <input type="file" id="audioInput" class="hidden" accept="audio/*" onchange="handleAudioImport(event)">
                        </button>
                        
                        <!-- Music Library -->
                        <div class="panel-section">
                            <div class="panel-header">
                                <span>Music Library</span>
                                <span class="text-xs text-success">Royalty Free</span>
                            </div>
                            <div class="panel-content">
                                <div class="audio-item" onclick="addMusic('upbeat')">
                                    <div class="audio-play-btn">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                    </div>
                                    <div class="audio-info">
                                        <div class="audio-title">Upbeat Energy</div>
                                        <div class="audio-meta">2:34 • Electronic</div>
                                    </div>
                                </div>
                                <div class="audio-item" onclick="addMusic('chill')">
                                    <div class="audio-play-btn">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                    </div>
                                    <div class="audio-info">
                                        <div class="audio-title">Chill Vibes</div>
                                        <div class="audio-meta">3:12 • Lo-Fi</div>
                                    </div>
                                </div>
                                <div class="audio-item" onclick="addMusic('cinematic')">
                                    <div class="audio-play-btn">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                    </div>
                                    <div class="audio-info">
                                        <div class="audio-title">Cinematic Rise</div>
                                        <div class="audio-meta">1:45 • Orchestral</div>
                                    </div>
                                </div>
                                <div class="audio-item" onclick="addMusic('happy')">
                                    <div class="audio-play-btn">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                    </div>
                                    <div class="audio-info">
                                        <div class="audio-title">Happy Days</div>
                                        <div class="audio-meta">2:15 • Acoustic</div>
                                    </div>
                                </div>
                                <div class="audio-item" onclick="addMusic('epic')">
                                    <div class="audio-play-btn">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                    </div>
                                    <div class="audio-info">
                                        <div class="audio-title">Epic Trailer</div>
                                        <div class="audio-meta">1:30 • Cinematic</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sound Effects -->
                        <div class="panel-section">
                            <div class="panel-header">Sound Effects</div>
                            <div class="panel-content grid grid-cols-2 gap-2">
                                <button class="btn btn-secondary btn-sm text-left" onclick="addSFX('whoosh')">🎵 Whoosh</button>
                                <button class="btn btn-secondary btn-sm text-left" onclick="addSFX('click')">🎵 Click</button>
                                <button class="btn btn-secondary btn-sm text-left" onclick="addSFX('pop')">🎵 Pop</button>
                                <button class="btn btn-secondary btn-sm text-left" onclick="addSFX('ding')">🎵 Ding</button>
                                <button class="btn btn-secondary btn-sm text-left" onclick="addSFX('swoosh')">🎵 Swoosh</button>
                                <button class="btn btn-secondary btn-sm text-left" onclick="addSFX('bass')">🎵 Bass Drop</button>
                                <button class="btn btn-secondary btn-sm text-left" onclick="addSFX('notification')">🎵 Notification</button>
                                <button class="btn btn-secondary btn-sm text-left" onclick="addSFX('transition')">🎵 Transition</button>
                            </div>
                        </div>
                        
                        <!-- Audio Adjustments -->
                        <div class="panel-section">
                            <div class="panel-header">Audio Adjustments</div>
                            <div class="panel-content space-y-4">
                                <div class="form-group m-0">
                                    <label class="form-label flex justify-between">
                                        <span>Volume</span>
                                        <span id="audioVolumeValue">100%</span>
                                    </label>
                                    <input type="range" min="0" max="200" value="100" id="audioVolume" oninput="updateAudioVolume(this.value)">
                                </div>
                                <div class="form-group m-0">
                                    <label class="form-label flex justify-between">
                                        <span>Fade In</span>
                                        <span id="fadeInValue">0s</span>
                                    </label>
                                    <input type="range" min="0" max="5" step="0.1" value="0" id="fadeIn" oninput="updateFade('in', this.value)">
                                </div>
                                <div class="form-group m-0">
                                    <label class="form-label flex justify-between">
                                        <span>Fade Out</span>
                                        <span id="fadeOutValue">0s</span>
                                    </label>
                                    <input type="range" min="0" max="5" step="0.1" value="0" id="fadeOut" oninput="updateFade('out', this.value)">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Voice Effects -->
                        <div class="panel-section">
                            <div class="panel-header">
                                <span>Voice Effects</span>
                                <span class="badge badge-ai">AI</span>
                            </div>
                            <div class="panel-content grid grid-cols-2 gap-2">
                                <button class="btn btn-secondary btn-sm" onclick="applyVoiceEffect('pitch-up')">🎤 Pitch Up</button>
                                <button class="btn btn-secondary btn-sm" onclick="applyVoiceEffect('pitch-down')">🎤 Pitch Down</button>
                                <button class="btn btn-secondary btn-sm" onclick="applyVoiceEffect('echo')">🎤 Echo</button>
                                <button class="btn btn-secondary btn-sm" onclick="applyVoiceEffect('reverb')">🎤 Reverb</button>
                                <button class="btn btn-secondary btn-sm" onclick="applyVoiceEffect('robot')">🎤 Robot</button>
                                <button class="btn btn-secondary btn-sm" onclick="applyVoiceEffect('deep')">🎤 Deep</button>
                            </div>
                        </div>
                        
                        <!-- Noise Reduction -->
                        <div class="panel-section">
                            <div class="panel-header">
                                <span>Audio Cleanup</span>
                                <span class="badge badge-ai">AI</span>
                            </div>
                            <div class="panel-content">
                                <button class="btn btn-block gradient-teal text-white" onclick="reduceNoise()">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                                    Remove Background Noise
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ADD THIS AFTER panel-audio -->
<div id="panel-advanced" class="panel-container hidden">
    <!-- Layers Panel -->
    <div class="panel-section">
        <div class="panel-header">
            <span>Layers</span>
            <button class="btn btn-ghost btn-sm p-1" onclick="addNewLayer()">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            </button>
        </div>
        <div class="panel-content" id="layersPanel">
            <div class="text-center text-muted py-4 text-sm">No visible layers</div>
        </div>
    </div>
    
    <!-- Blend Modes -->
    <div class="panel-section">
        <div class="panel-header">Blend Mode</div>
        <div class="panel-content">
            <select class="form-select" id="blendModeSelect" onchange="setBlendMode(this.value)">
                <option value="normal">Normal</option>
                <option value="multiply">Multiply</option>
                <option value="screen">Screen</option>
                <option value="overlay">Overlay</option>
                <option value="darken">Darken</option>
                <option value="lighten">Lighten</option>
                <option value="color-dodge">Color Dodge</option>
                <option value="color-burn">Color Burn</option>
                <option value="hard-light">Hard Light</option>
                <option value="soft-light">Soft Light</option>
                <option value="difference">Difference</option>
                <option value="exclusion">Exclusion</option>
            </select>
        </div>
    </div>
    
    <!-- Chroma Key -->
    <div class="panel-section">
        <div class="panel-header">Chroma Key (Green Screen)</div>
        <div class="panel-content">
            <div class="form-group">
                <label class="form-label">Key Color</label>
                <div class="flex gap-2">
                    <input type="color" value="#00ff00" id="chromaColor" class="w-12 h-10 rounded cursor-pointer" onchange="updateChromaKey()">
                    <button class="btn btn-secondary btn-sm flex-1" onclick="pickChromaColor()">
                        Pick Color
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label flex justify-between">
                    <span>Similarity</span>
                    <span id="chromaSimilarityValue">40</span>
                </label>
                <input type="range" min="0" max="100" value="40" id="chromaSimilarity" oninput="updateChromaKey()">
            </div>
            <div class="form-group">
                <label class="form-label flex justify-between">
                    <span>Smoothness</span>
                    <span id="chromaSmoothnessValue">10</span>
                </label>
                <input type="range" min="0" max="100" value="10" id="chromaSmoothness" oninput="updateChromaKey()">
            </div>
            <div class="form-group m-0">
                <label class="form-label flex justify-between">
                    <span>Spill Suppression</span>
                    <span id="chromaSpillValue">50</span>
                </label>
                <input type="range" min="0" max="100" value="50" id="chromaSpill" oninput="updateChromaKey()">
            </div>
        </div>
    </div>
    
    <!-- Masking -->
    <div class="panel-section">
        <div class="panel-header">Masking</div>
        <div class="panel-content space-y-2">
            <button class="btn btn-secondary btn-block btn-sm" onclick="createMask('rectangle')">Rectangle Mask</button>
            <button class="btn btn-secondary btn-block btn-sm" onclick="createMask('ellipse')">Ellipse Mask</button>
            <button class="btn btn-secondary btn-block btn-sm" onclick="createMask('freehand')">Freehand Mask</button>
            <div class="mt-3">
                <label class="form-label">Feather</label>
                <input type="range" min="0" max="100" value="0" id="maskFeather" oninput="updateMaskFeather(this.value)">
            </div>
            <label class="flex items-center gap-2 text-sm mt-2 cursor-pointer">
                <input type="checkbox" id="invertMask" onchange="toggleInvertMask(this.checked)">
                Invert Mask
            </label>
        </div>
    </div>
    
    <!-- Motion Tracking -->
    <div class="panel-section">
        <div class="panel-header">
            <span>Motion Tracking</span>
            <span class="badge badge-ai">AI</span>
        </div>
        <div class="panel-content">
            <p class="text-xs text-muted mb-3">Track objects or faces in your video</p>
            <button class="btn btn-block gradient-purple text-white mb-2" onclick="startMotionTracking()">
                Start Tracking
            </button>
            <div class="grid grid-cols-2 gap-2">
                <button class="btn btn-secondary btn-sm" onclick="trackFace()">Track Face</button>
                <button class="btn btn-secondary btn-sm" onclick="trackObject()">Track Object</button>
            </div>
        </div>
    </div>
    
    <!-- Markers -->
    <div class="panel-section">
        <div class="panel-header">
            <span>Markers</span>
            <button class="btn btn-ghost btn-sm p-1" onclick="addMarker()">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            </button>
        </div>
        <div class="panel-content" id="markersPanel">
            <div class="text-center text-muted py-4 text-sm">No markers</div>
        </div>
    </div>
    
    <!-- Color Grading -->
    <div class="panel-section">
        <div class="panel-header">Color Grading</div>
        <div class="panel-content">
            <button class="btn btn-block gradient-purple text-white" onclick="openColorGrading()">
                Open Color Grading
            </button>
        </div>
    </div>
    
    <!-- Keyframe Editor -->
    <div class="panel-section">
        <div class="panel-header">Keyframe Editor</div>
        <div class="panel-content">
            <button class="btn btn-block btn-secondary" onclick="openKeyframeEditor()">
                Open Keyframe Editor
            </button>
        </div>
    </div>
</div>
            </aside>

            <!-- ===== CENTER AREA - Preview & Timeline ===== -->
            <main class="flex-1 flex flex-col min-w-0">
                <!-- Preview Area -->
                <div class="flex-1 bg-[#050508] flex items-center justify-center p-4 relative overflow-hidden">
                    <div class="relative bg-black rounded-xl overflow-hidden shadow-2xl" id="previewContainer" style="aspect-ratio: 16/9; max-height: 100%; max-width: 100%;">
                        <canvas id="previewCanvas" class="w-full h-full"></canvas>
                        
                        <!-- Safe Zones Overlay -->
                        <div id="safeZonesOverlay" class="absolute inset-0 pointer-events-none hidden">
                            <div class="absolute inset-[5%] border border-dashed border-white/20"></div>
                            <div class="absolute inset-[10%] border border-dashed border-white/10"></div>
                        </div>
                        
                        <!-- Grid Overlay -->
                        <div id="gridOverlay" class="absolute inset-0 pointer-events-none hidden" style="background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px); background-size: 10% 10%;"></div>
                    </div>
                    
                    <!-- Preview Info -->
                    <div class="absolute top-4 left-4 flex items-center gap-2">
                        <div class="bg-black/70 backdrop-blur px-3 py-1.5 rounded-lg text-xs flex items-center gap-2">
                            <span id="previewResolution">1920 × 1080</span>
                            <span class="text-muted">|</span>
                            <span id="previewFps">30fps</span>
                        </div>
                    </div>
                    
                    <!-- Preview Zoom Controls -->
                    <div class="absolute bottom-4 right-4 flex items-center gap-2 bg-black/70 backdrop-blur rounded-lg px-3 py-1.5">
                        <button class="p-1 hover:bg-white/10 rounded" onclick="zoomPreview(-10)">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg>
                        </button>
                        <span class="text-xs w-12 text-center" id="previewZoomLevel">100%</span>
                        <button class="p-1 hover:bg-white/10 rounded" onclick="zoomPreview(10)">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        </button>
                        <div class="w-px h-4 bg-white/20"></div>
                        <button class="p-1 hover:bg-white/10 rounded" onclick="fitPreview()" title="Fit to view">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Playback Controls -->
                <div class="h-16 bg-[#0d0d18] border-t border-b flex items-center justify-center gap-6 px-6 shrink-0">
                    <!-- Transport Controls -->
                    <div class="flex items-center gap-1">
                        <button class="tool-btn p-2" onclick="goToStart()" title="Go to start (Home)">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                        </button>
                        <button class="tool-btn p-2" onclick="previousFrame()" title="Previous frame (←)">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/></svg>
                        </button>
                    </div>
                    
                    <!-- Play Button -->
                    <button class="w-14 h-14 rounded-full gradient-purple flex items-center justify-center hover:opacity-90 transition shadow-lg shadow-purple-500/30" onclick="togglePlayback()" id="playBtn">
                        <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24" id="playIcon"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                    
                    <div class="flex items-center gap-1">
                        <button class="tool-btn p-2" onclick="nextFrame()" title="Next frame (→)">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"/></svg>
                        </button>
                        <button class="tool-btn p-2" onclick="goToEnd()" title="Go to end (End)">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zm10 0h2V6h-2v12z"/></svg>
                        </button>
                    </div>
                    
                    <div class="h-8 w-px bg-gray-700"></div>
                    
                    <!-- Time Display -->
                    <div class="flex items-center gap-3">
                        <span class="font-mono bg-[#1a1a2e] px-4 py-2 rounded-lg text-sm" id="currentTime">00:00:00:00</span>
                        <span class="text-muted">/</span>
                        <span class="font-mono text-secondary text-sm" id="totalDuration">00:00:10:00</span>
                    </div>
                    
                    <div class="h-8 w-px bg-gray-700"></div>
                    
                    <!-- FPS Selector -->
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-muted">FPS:</span>
                        <select class="form-select py-1 px-2 text-sm w-20" id="fpsSelect" onchange="setFPS(this.value)">
                            <option value="24">24</option>
                            <option value="30" selected>30</option>
                            <option value="60">60</option>
                        </select>
                    </div>
                    
                    <div class="h-8 w-px bg-gray-700"></div>
                    
                    <!-- Volume -->
                    <div class="flex items-center gap-2">
                        <button class="tool-btn p-2" onclick="toggleMute()" id="muteBtn" title="Toggle mute (M)">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" id="volumeIcon"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                        </button>
                        <input type="range" min="0" max="100" value="80" class="w-24" id="volumeSlider" oninput="setMasterVolume(this.value)">
                    </div>
                    
                    <div class="h-8 w-px bg-gray-700"></div>
                    
                    <!-- Loop Toggle -->
                    <button class="tool-btn p-2" onclick="toggleLoop()" id="loopBtn" title="Toggle loop (L)">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                    </button>
                </div>

                <!-- Timeline -->
                <div class="h-64 bg-[#0d0d18] flex flex-col shrink-0">
                    <!-- Timeline Toolbar -->
                    <div class="h-10 bg-[#12121f] border-b flex items-center px-3 gap-2">
                        <!-- Tools -->
                        <div class="flex gap-1">
                            <button class="tool-btn p-1.5 active" id="selectTool" onclick="setTool('select')" title="Select Tool (V)">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/></svg>
                            </button>
                            <button class="tool-btn p-1.5" id="razorTool" onclick="setTool('razor')" title="Razor Tool (C)">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M9.64 7.64c.23-.5.36-1.05.36-1.64 0-2.21-1.79-4-4-4S2 3.79 2 6s1.79 4 4 4c.59 0 1.14-.13 1.64-.36L10 12l-2.36 2.36C7.14 14.13 6.59 14 6 14c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4c0-.59-.13-1.14-.36-1.64L12 14l7 7h3v-1L9.64 7.64z"/></svg>
                            </button>
                            <button class="tool-btn p-1.5" id="handTool" onclick="setTool('hand')" title="Hand Tool (H)">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11"/></svg>
                            </button>
                        </div>
                        
                        <div class="h-6 w-px bg-gray-700"></div>
                        
                        <!-- Edit Actions -->
                        <button class="tool-btn px-2 py-1 text-xs gap-1" onclick="splitAtPlayhead()" title="Split at Playhead (S)">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg>
                            Split
                        </button>
                        <button class="tool-btn px-2 py-1 text-xs gap-1" onclick="deleteSelected()" title="Delete Selected (Del)">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                            Delete
                        </button>
                        <button class="tool-btn px-2 py-1 text-xs gap-1" onclick="duplicateSelected()" title="Duplicate (Ctrl+D)">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                            Duplicate
                        </button>
                        
                        <div class="h-6 w-px bg-gray-700"></div>
                        
                        <!-- Add Track -->
                        <div class="dropdown">
                            <button class="tool-btn px-2 py-1 text-xs gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                Add Track
                            </button>
                            <div class="dropdown-menu">
                                <div class="dropdown-item" onclick="addTrack('video')">Video Track</div>
                                <div class="dropdown-item" onclick="addTrack('audio')">Audio Track</div>
                                <div class="dropdown-item" onclick="addTrack('text')">Text Track</div>
                            </div>
                        </div>
                        
                        <div class="flex-1"></div>
                        
                        <!-- Zoom Controls -->
                        <div class="flex items-center gap-2">
                            <button class="tool-btn p-1" onclick="zoomTimeline(-10)" title="Zoom Out">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"/></svg>
                            </button>
                            <input type="range" min="10" max="200" value="50" class="w-24" id="zoomSlider" oninput="setTimelineZoom(this.value)">
                            <button class="tool-btn p-1" onclick="zoomTimeline(10)" title="Zoom In">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"/></svg>
                            </button>
                            <span class="text-xs text-muted w-12" id="zoomLevel">50%</span>
                        </div>
                        
                        <div class="h-6 w-px bg-gray-700"></div>
                        
                        <!-- Snap Toggle -->
                        <button class="tool-btn p-1.5 active" onclick="toggleSnapping()" id="snapBtn" title="Toggle Snapping (N)">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M3 3v18h18v-2H5V3H3zm14 12l-4-4-4 4v2h8v-2z"/></svg>
                        </button>
                    </div>
                    
                    <!-- Time Ruler -->
                    <div class="h-6 bg-[#1a1a2e] flex relative border-b">
                        <div class="track-label flex items-center justify-center text-xs text-muted border-r">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        </div>
                        <div class="flex-1 relative overflow-hidden" id="timeRuler" onclick="scrubTimeline(event)"></div>
                    </div>
                    
                    <!-- Tracks Container -->
                    <div class="flex-1 overflow-auto relative" id="tracksContainer">
                        <div id="tracksWrapper"></div>
                        <div class="playhead" id="playhead" style="left: 140px;"></div>
                        <!-- Snap Guide Lines -->
                        <div id="snapGuides"></div>
                    </div>
                </div>
            </main>

            <!-- ===== RIGHT SIDEBAR - Properties ===== -->
            <aside class="w-80 bg-[#0d0d18] border-l flex flex-col shrink-0">
                <div class="p-4 border-b flex items-center justify-between">
                    <h3 class="font-semibold" id="propertiesTitle">Properties</h3>
                    <button class="tool-btn p-1" onclick="closeProperties()" title="Close">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-4" id="propertiesPanel">
                    <div class="text-center py-12 text-muted">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>
                        <p class="text-sm">Select a clip to edit its properties</p>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- ========== MODALS ========== -->
    
    <!-- Export Modal -->
    <div id="exportModal" class="modal-backdrop">
        <div class="modal-content w-[550px]">
            <div class="modal-header">
                <h2 class="modal-title">Export Video</h2>
                <div class="modal-close" onclick="hideModal('exportModal')">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </div>
            </div>
            <div class="modal-body" id="exportSettings">
                <div class="form-group">
                    <label class="form-label">Resolution</label>
                    <select class="form-select" id="exportResolution">
                        <option value="4k">4K Ultra HD (3840 × 2160)</option>
                        <option value="1080p" selected>Full HD (1920 × 1080)</option>
                        <option value="720p">HD (1280 × 720)</option>
                        <option value="480p">SD (854 × 480)</option>
                        <option value="vertical">Vertical (1080 × 1920)</option>
                        <option value="square">Square (1080 × 1080)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Frame Rate</label>
                    <select class="form-select" id="exportFPS">
                        <option value="24">24 fps (Cinematic)</option>
                        <option value="30" selected>30 fps (Standard)</option>
                        <option value="60">60 fps (Smooth)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Format</label>
                    <select class="form-select" id="exportFormat">
                        <option value="mp4">MP4 (H.264) - Most Compatible</option>
                        <option value="webm">WebM (VP9) - Web Optimized</option>
                        <option value="mov">MOV (ProRes) - High Quality</option>
                        <option value="gif">GIF - Animated Image</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label flex justify-between">
                        <span>Quality</span>
                        <span id="exportQualityValue">80%</span>
                    </label>
                    <input type="range" min="1" max="100" value="80" id="exportQuality" oninput="document.getElementById('exportQualityValue').textContent = this.value + '%'">
                    <div class="flex justify-between text-xs text-muted mt-1">
                        <span>Smaller file</span>
                        <span>Better quality</span>
                    </div>
                </div>
            </div>
            <div id="exportProgress" class="modal-body hidden">
                <div class="text-center py-6">
                    <div class="relative inline-block mb-4">
                        <svg class="w-24 h-24 progress-ring">
                            <circle cx="48" cy="48" r="40" stroke="#252540" stroke-width="8" fill="none"/>
                            <circle id="exportProgressCircle" class="progress-ring-circle" cx="48" cy="48" r="40" stroke="url(#progressGradient)" stroke-width="8" fill="none" stroke-dasharray="251.2" stroke-dashoffset="251.2"/>
                            <defs>
                                <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" stop-color="#8b5cf6"/>
                                    <stop offset="100%" stop-color="#ec4899"/>
                                </linearGradient>
                            </defs>
                        </svg>
                        <span class="absolute inset-0 flex items-center justify-center text-2xl font-bold" id="exportPercent">0%</span>
                    </div>
                    <div class="font-medium mb-1" id="exportStatus">Preparing...</div>
                    <div class="text-sm text-muted" id="exportDetail">Initializing encoder</div>
                </div>
            </div>
            <div class="modal-footer" id="exportFooter">
                <button class="btn btn-secondary" onclick="hideModal('exportModal')">Cancel</button>
                <button class="btn btn-primary" onclick="startExport()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    Export
                </button>
            </div>
        </div>
    </div>

    <!-- Speed/Duration Modal -->
    <div id="speedModal" class="modal-backdrop">
        <div class="modal-content w-[450px]">
            <div class="modal-header">
                <h2 class="modal-title">Speed & Duration</h2>
                <div class="modal-close" onclick="hideModal('speedModal')">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Playback Speed</label>
                    <input type="range" min="0.1" max="4" step="0.1" value="1" id="speedSlider" oninput="updateSpeedDisplay(this.value)">
                    <div class="flex justify-between items-center mt-3">
                        <span class="text-xs text-muted">0.1x</span>
                        <span class="text-3xl font-bold text-accent" id="speedDisplay">1.0x</span>
                        <span class="text-xs text-muted">4.0x</span>
                    </div>
                </div>
                <div class="flex gap-2 mb-4">
                    <button class="btn btn-secondary btn-sm flex-1" onclick="setQuickSpeed(0.25)">0.25x</button>
                    <button class="btn btn-secondary btn-sm flex-1" onclick="setQuickSpeed(0.5)">0.5x</button>
                    <button class="btn btn-secondary btn-sm flex-1" onclick="setQuickSpeed(1)">1x</button>
                    <button class="btn btn-secondary btn-sm flex-1" onclick="setQuickSpeed(1.5)">1.5x</button>
                    <button class="btn btn-secondary btn-sm flex-1" onclick="setQuickSpeed(2)">2x</button>
                    <button class="btn btn-secondary btn-sm flex-1" onclick="setQuickSpeed(4)">4x</button>
                </div>
                <label class="flex items-center gap-3 text-sm mb-2 cursor-pointer">
                    <input type="checkbox" id="maintainPitch" checked>
                    Maintain audio pitch
                </label>
                <label class="flex items-center gap-3 text-sm cursor-pointer">
                    <input type="checkbox" id="rippleEdit">
                    Ripple edit (shift following clips)
                </label>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('speedModal')">Cancel</button>
                <button class="btn btn-primary" onclick="applySpeed()">Apply</button>
            </div>
        </div>
    </div>

    <!-- Transition Modal -->
    <div id="transitionModal" class="modal-backdrop">
        <div class="modal-content w-[500px]">
            <div class="modal-header">
                <h2 class="modal-title">Add Transition</h2>
                <div class="modal-close" onclick="hideModal('transitionModal')">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </div>
            </div>
            <div class="modal-body">
                <div class="grid grid-cols-3 gap-3 mb-4" id="transitionGrid">
                    <!-- Transitions will be rendered here -->
                </div>
                <div class="form-group m-0">
                    <label class="form-label">Duration: <span id="modalTransitionDuration">0.5</span>s</label>
                    <input type="range" min="0.1" max="2" step="0.1" value="0.5" id="modalTransitionSlider" oninput="document.getElementById('modalTransitionDuration').textContent = this.value">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('transitionModal')">Cancel</button>
                <button class="btn btn-primary" onclick="applyTransition()">Apply</button>
            </div>
        </div>
    </div>
<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay hidden">
    <div class="spinner spinner-lg" style="width:64px;height:64px;border-width:4px;margin-bottom:24px;"></div>
    <div class="loading-text" id="loadingText">Loading...</div>
    <div class="loading-detail" id="loadingDetail">Please wait</div>
    <div class="progress-bar w-64 mt-4">
        <div class="progress-fill" id="loadingProgress" style="width: 0%"></div>
    </div>
</div>

<!-- Keyframe Editor Modal -->
<div id="keyframeModal" class="modal-backdrop">
    <div class="modal-content w-[600px]">
        <div class="modal-header">
            <h2 class="modal-title">Keyframe Editor</h2>
            <div class="modal-close" onclick="hideModal('keyframeModal')">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </div>
        </div>
        <div class="modal-body">
            <div class="flex gap-4">
                <!-- Properties -->
                <div class="w-32 shrink-0">
                    <div class="text-xs text-muted uppercase mb-2">Properties</div>
                    <div class="space-y-1" id="keyframeProperties">
                        <div class="p-2 bg-[#252540] rounded cursor-pointer hover:bg-[#2f2f50] text-sm" onclick="selectKFProperty('x')">Position X</div>
                        <div class="p-2 bg-[#252540] rounded cursor-pointer hover:bg-[#2f2f50] text-sm" onclick="selectKFProperty('y')">Position Y</div>
                        <div class="p-2 bg-[#252540] rounded cursor-pointer hover:bg-[#2f2f50] text-sm" onclick="selectKFProperty('scale')">Scale</div>
                        <div class="p-2 bg-[#252540] rounded cursor-pointer hover:bg-[#2f2f50] text-sm" onclick="selectKFProperty('rotation')">Rotation</div>
                        <div class="p-2 bg-[#252540] rounded cursor-pointer hover:bg-[#2f2f50] text-sm" onclick="selectKFProperty('opacity')">Opacity</div>
                    </div>
                </div>
                
                <!-- Curve Editor -->
                <div class="flex-1">
                    <div class="text-xs text-muted uppercase mb-2">Animation Curve</div>
                    <div class="bg-[#1a1a2e] rounded-lg p-4 mb-4">
                        <canvas id="curveCanvas" width="400" height="150" class="w-full rounded"></canvas>
                    </div>
                    
                    <!-- Easing Presets -->
                    <div class="text-xs text-muted uppercase mb-2">Easing Presets</div>
                    <div class="grid grid-cols-6 gap-2">
                        <button class="btn btn-secondary btn-sm text-xs" onclick="setEasing('linear')">Linear</button>
                        <button class="btn btn-secondary btn-sm text-xs" onclick="setEasing('ease')">Ease</button>
                        <button class="btn btn-secondary btn-sm text-xs" onclick="setEasing('ease-in')">Ease In</button>
                        <button class="btn btn-secondary btn-sm text-xs" onclick="setEasing('ease-out')">Ease Out</button>
                        <button class="btn btn-secondary btn-sm text-xs" onclick="setEasing('ease-in-out')">Ease I/O</button>
                        <button class="btn btn-secondary btn-sm text-xs" onclick="setEasing('bounce')">Bounce</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="clearAllKeyframes()">Clear All</button>
            <div class="flex-1"></div>
            <button class="btn btn-secondary" onclick="hideModal('keyframeModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveKeyframeChanges()">Apply</button>
        </div>
    </div>
</div>

<!-- Color Grading Modal -->
<div id="colorGradingModal" class="modal-backdrop">
    <div class="modal-content w-[700px]">
        <div class="modal-header">
            <h2 class="modal-title">Color Grading</h2>
            <div class="modal-close" onclick="hideModal('colorGradingModal')">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </div>
        </div>
        <div class="modal-body">
            <!-- Color Wheels -->
            <div class="text-xs text-muted uppercase mb-3">Color Wheels</div>
            <div class="grid grid-cols-3 gap-6 mb-6">
                <div class="text-center">
                    <div class="text-xs mb-2">Shadows</div>
                    <div class="color-wheel mx-auto" style="width:100px" id="shadowsWheel">
                        <div class="color-wheel-inner">
                            <div class="color-wheel-pointer"></div>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-xs mb-2">Midtones</div>
                    <div class="color-wheel mx-auto" style="width:100px" id="midtonesWheel">
                        <div class="color-wheel-inner">
                            <div class="color-wheel-pointer"></div>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-xs mb-2">Highlights</div>
                    <div class="color-wheel mx-auto" style="width:100px" id="highlightsWheel">
                        <div class="color-wheel-inner">
                            <div class="color-wheel-pointer"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sliders -->
            <div class="grid grid-cols-2 gap-4">
                <div class="form-group m-0">
                    <label class="form-label flex justify-between">
                        <span>Exposure</span>
                        <span id="exposureValue">0</span>
                    </label>
                    <input type="range" min="-100" max="100" value="0" id="exposureSlider" oninput="updateColorGrading('exposure', this.value)">
                </div>
                <div class="form-group m-0">
                    <label class="form-label flex justify-between">
                        <span>Gamma</span>
                        <span id="gammaValue">0</span>
                    </label>
                    <input type="range" min="-100" max="100" value="0" id="gammaSlider" oninput="updateColorGrading('gamma', this.value)">
                </div>
                <div class="form-group m-0">
                    <label class="form-label flex justify-between">
                        <span>Lift</span>
                        <span id="liftValue">0</span>
                    </label>
                    <input type="range" min="-100" max="100" value="0" id="liftSlider" oninput="updateColorGrading('lift', this.value)">
                </div>
                <div class="form-group m-0">
                    <label class="form-label flex justify-between">
                        <span>Gain</span>
                        <span id="gainValue">0</span>
                    </label>
                    <input type="range" min="-100" max="100" value="0" id="gainSlider" oninput="updateColorGrading('gain', this.value)">
                </div>
            </div>
            
            <!-- Histogram -->
            <div class="mt-4">
                <div class="text-xs text-muted uppercase mb-2">Histogram</div>
                <div class="histogram" id="histogramDisplay"></div>
            </div>
            
            <!-- LUT -->
            <div class="mt-4">
                <div class="text-xs text-muted uppercase mb-2">LUT Presets</div>
                <select class="form-select" id="lutPresets" onchange="applyLUTPreset(this.value)">
                    <option value="">-- Select LUT --</option>
                    <option value="cinematic">Cinematic</option>
                    <option value="vintage">Vintage Film</option>
                    <option value="teal-orange">Teal & Orange</option>
                    <option value="noir">Film Noir</option>
                    <option value="pastel">Pastel</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="resetColorGrading()">Reset</button>
            <div class="flex-1"></div>
            <button class="btn btn-secondary" onclick="hideModal('colorGradingModal')">Cancel</button>
            <button class="btn btn-primary" onclick="applyColorGrading()">Apply</button>
        </div>
    </div>
</div>
    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" onclick="splitAtPlayhead(); hideContextMenu();">
            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg>
            Split at Playhead
            <span class="shortcut">S</span>
        </div>
        <div class="context-menu-item" onclick="duplicateSelected(); hideContextMenu();">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2"/></svg>
            Duplicate
            <span class="shortcut">Ctrl+D</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="showModal('speedModal'); hideContextMenu();">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            Speed/Duration...
        </div>
        <div class="context-menu-item" onclick="reverseClip(); hideContextMenu();">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            Reverse
        </div>
        <div class="context-menu-item" onclick="freezeFrame(); hideContextMenu();">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            Freeze Frame
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="showModal('transitionModal'); hideContextMenu();">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>
            Add Transition...
        </div>
        <div class="context-menu-item" onclick="addKeyframe(); hideContextMenu();">
            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
            Add Keyframe
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item danger" onclick="deleteSelected(); hideContextMenu();">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            Delete
            <span class="shortcut">Del</span>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ========== JAVASCRIPT ========== -->
    <script>
        // ==========================================
        // FLOWCUT PRO - COMPLETE VIDEO EDITOR
        // ==========================================

        // ===== APPLICATION STATE =====
        const state = {
            project: {
                name: 'Untitled Project',
                resolution: { width: 1920, height: 1080 },
                fps: 30,
                duration: 300, // frames
                aspectRatio: '16:9'
            },
            timeline: {
                zoom: 50,
                scrollX: 0,
                snapping: true,
                playheadPosition: 0,
                isPlaying: false,
                loop: false,
                selectedTransition: null,
                transitionDuration: 0.5
            },
            tracks: [
                { id: 'v3', name: 'Overlay', type: 'video', height: 45, muted: false, locked: false, visible: true },
                { id: 'v2', name: 'Video 2', type: 'video', height: 45, muted: false, locked: false, visible: true },
                { id: 'v1', name: 'Video 1', type: 'video', height: 50, muted: false, locked: false, visible: true, isMain: true },
                { id: 't1', name: 'Text', type: 'text', height: 40, muted: false, locked: false, visible: true },
                { id: 'a1', name: 'Audio 1', type: 'audio', height: 40, muted: false, locked: false, visible: true },
                { id: 'a2', name: 'Audio 2', type: 'audio', height: 40, muted: false, locked: false, visible: true },
                { id: 'a3', name: 'Music', type: 'audio', height: 40, muted: false, locked: false, visible: true }
            ],
            clips: [],
            selectedClips: [],
            mediaLibrary: [],
            currentTool: 'select',
            clipboard: null,
            keyframes: {},
            colorAdjustments: {
                brightness: 0,
                contrast: 0,
                saturation: 0,
                temperature: 0,
                vignette: 0,
                blur: 0
            },
            currentFilter: 'none',
            masterVolume: 80,
            isMuted: false,
            undoStack: [],
            redoStack: [],
            showSafeZones: true,
            showGrid: false,
            previewZoom: 100
        };

        let clipIdCounter = 0;
        let trackIdCounter = 10;
        let animationFrame = null;
        let lastFrameTime = 0;
        let canvas, ctx;
        let isDragging = false;
        let dragData = null;

        // ===== INITIALIZATION =====
        function init() {
            canvas = document.getElementById('previewCanvas');
            ctx = canvas.getContext('2d');
            canvas.width = state.project.resolution.width;
            canvas.height = state.project.resolution.height;

            setupEventListeners();
            renderTimeline();
            renderTimeRuler();
            addDemoContent();
            updateTimeDisplay();
            renderPreview();
            
            console.log('FlowCut Pro initialized!');
        }

        function setupEventListeners() {
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyDown);
            
            // Context menu
            document.addEventListener('contextmenu', handleContextMenu);
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.context-menu')) {
                    hideContextMenu();
                }
                if (!e.target.closest('.dropdown')) {
                    document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
                }
            });

            // Timeline scrubbing
            const timeRuler = document.getElementById('timeRuler');
            timeRuler.addEventListener('mousedown', startScrubbing);

            // Playhead dragging
            document.getElementById('tracksContainer').addEventListener('mousedown', handleTimelineClick);

            // Window resize
            window.addEventListener('resize', handleResize);

            // Prevent default drag behaviors
            document.addEventListener('dragover', (e) => e.preventDefault());
        }

        function handleKeyDown(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

            const key = e.key.toLowerCase();
            const ctrl = e.ctrlKey || e.metaKey;
            const shift = e.shiftKey;

            switch(key) {
                case ' ':
                    e.preventDefault();
                    togglePlayback();
                    break;
                case 'v':
                    if (!ctrl) setTool('select');
                    break;
                case 'c':
                    if (ctrl) copyClip();
                    else setTool('razor');
                    break;
                case 'h':
                    setTool('hand');
                    break;
                case 's':
                    if (ctrl) { e.preventDefault(); saveProject(); }
                    else splitAtPlayhead();
                    break;
                case 'delete':
                case 'backspace':
                    e.preventDefault();
                    deleteSelected();
                    break;
                case 'd':
                    if (ctrl) { e.preventDefault(); duplicateSelected(); }
                    break;
                case 'z':
                    if (ctrl) {
                        e.preventDefault();
                        if (shift) redo();
                        else undo();
                    }
                    break;
                case 'y':
                    if (ctrl) { e.preventDefault(); redo(); }
                    break;
                case 'a':
                    if (ctrl) { e.preventDefault(); selectAll(); }
                    break;
                case 'arrowleft':
                    e.preventDefault();
                    if (shift) state.timeline.playheadPosition = Math.max(0, state.timeline.playheadPosition - 10);
                    else state.timeline.playheadPosition = Math.max(0, state.timeline.playheadPosition - 1);
                    updatePlayhead();
                    renderPreview();
                    break;
                case 'arrowright':
                    e.preventDefault();
                    if (shift) state.timeline.playheadPosition = Math.min(state.project.duration, state.timeline.playheadPosition + 10);
                    else state.timeline.playheadPosition = Math.min(state.project.duration, state.timeline.playheadPosition + 1);
                    updatePlayhead();
                    renderPreview();
                    break;
                case 'home':
                    e.preventDefault();
                    goToStart();
                    break;
                case 'end':
                    e.preventDefault();
                    goToEnd();
                    break;
                case 'n':
                    if (ctrl) { e.preventDefault(); newProject(); }
                    else toggleSnapping();
                    break;
                case 'e':
                    if (ctrl) { e.preventDefault(); showModal('exportModal'); }
                    break;
                case 'm':
                    toggleMute();
                    break;
                case 'l':
                    toggleLoop();
                    break;
                case 'escape':
                    deselectAll();
                    hideAllModals();
                    break;
            }
        }

        // ===== DEMO CONTENT =====
        function addDemoContent() {
            const colors = {
                video: ['#8b5cf6', '#ec4899', '#06b6d4', '#10b981', '#f59e0b'],
                audio: ['#22c55e', '#3b82f6', '#14b8a6'],
                text: ['#fbbf24', '#f97316']
            };

            const demoClips = [
                {
                    id: 'clip_' + (++clipIdCounter),
                    trackId: 'v1',
                    name: 'Intro Scene',
                    type: 'video',
                    color: colors.video[0],
                    startFrame: 0,
                    durationFrames: 90,
                    sourceIn: 0,
                    sourceOut: 90,
                    speed: 1,
                    volume: 1,
                    filter: null,
                    effects: [],
                    transform: { x: 0, y: 0, scale: 1, rotation: 0, opacity: 1 }
                },
                {
                    id: 'clip_' + (++clipIdCounter),
                    trackId: 'v1',
                    name: 'Main Content',
                    type: 'video',
                    color: colors.video[1],
                    startFrame: 90,
                    durationFrames: 120,
                    sourceIn: 0,
                    sourceOut: 120,
                    speed: 1,
                    volume: 1,
                    filter: null,
                    effects: [],
                    transform: { x: 0, y: 0, scale: 1, rotation: 0, opacity: 1 }
                },
                {
                    id: 'clip_' + (++clipIdCounter),
                    trackId: 'v1',
                    name: 'Outro',
                    type: 'video',
                    color: colors.video[2],
                    startFrame: 210,
                    durationFrames: 90,
                    sourceIn: 0,
                    sourceOut: 90,
                    speed: 1,
                    volume: 1,
                    filter: null,
                    effects: [],
                    transform: { x: 0, y: 0, scale: 1, rotation: 0, opacity: 1 }
                },
                {
                    id: 'clip_' + (++clipIdCounter),
                    trackId: 't1',
                    name: 'Title Text',
                    type: 'text',
                    color: colors.text[0],
                    startFrame: 15,
                    durationFrames: 60,
                    text: 'Welcome to FlowCut!',
                    fontSize: 72,
                    fontFamily: 'Inter',
                    fontWeight: 700,
                    textAlign: 'center',
                    textColor: '#ffffff',
                    backgroundColor: 'transparent',
                    animation: 'fadeIn',
                    transform: { x: 0, y: 0, scale: 1, rotation: 0, opacity: 1 }
                },
                {
                    id: 'clip_' + (++clipIdCounter),
                    trackId: 'a1',
                    name: 'Background Music',
                    type: 'audio',
                    color: colors.audio[0],
                    startFrame: 0,
                    durationFrames: 300,
                    volume: 0.6,
                    fadeIn: 0.5,
                    fadeOut: 1,
                    sourceIn: 0,
                    sourceOut: 300
                },
                {
                    id: 'clip_' + (++clipIdCounter),
                    trackId: 'a2',
                    name: 'Voiceover',
                    type: 'audio',
                    color: colors.audio[1],
                    startFrame: 30,
                    durationFrames: 180,
                    volume: 1,
                    fadeIn: 0,
                    fadeOut: 0,
                    sourceIn: 0,
                    sourceOut: 180
                }
            ];

            state.clips = demoClips;
            renderTimeline();
            renderPreview();
        }

        // ===== TIMELINE RENDERING =====
        function renderTimeline() {
            const wrapper = document.getElementById('tracksWrapper');
            wrapper.innerHTML = '';

            state.tracks.forEach(track => {
                const trackRow = document.createElement('div');
                trackRow.className = 'track-row';
                trackRow.style.height = track.height + 'px';
                trackRow.dataset.trackId = track.id;

                // Track Label
                const label = document.createElement('div');
                label.className = 'track-label';
                label.innerHTML = `
                    <div class="track-type-indicator ${track.type}"></div>
                    <span class="track-name">${track.name}</span>
                    <div class="track-controls">
                        <div class="track-btn ${track.muted ? 'muted' : ''}" onclick="toggleTrackMute('${track.id}')" title="Mute">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">${track.muted ? '<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>' : '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>'}</svg>
                        </div>
                        <div class="track-btn ${track.locked ? 'active' : ''}" onclick="toggleTrackLock('${track.id}')" title="Lock">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">${track.locked ? '<path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>' : '<path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h1.9c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10z"/>'}</svg>
                        </div>
                        <div class="track-btn ${!track.visible ? 'muted' : ''}" onclick="toggleTrackVisibility('${track.id}')" title="Visibility">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">${track.visible ? '<path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>' : '<path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>'}</svg>
                        </div>
                    </div>
                `;

                // Track Content
                const content = document.createElement('div');
                content.className = 'track-content';
                content.dataset.trackId = track.id;
                content.ondragover = (e) => e.preventDefault();
                content.ondrop = (e) => handleTrackDrop(e, track.id);

                // Render clips for this track
                const trackClips = state.clips.filter(c => c.trackId === track.id);
                trackClips.forEach(clip => {
                    const clipEl = createClipElement(clip, track);
                    content.appendChild(clipEl);
                });

                trackRow.appendChild(label);
                trackRow.appendChild(content);
                wrapper.appendChild(trackRow);
            });

            updatePlayhead();
        }

        function createClipElement(clip, track) {
            const pixelsPerFrame = state.timeline.zoom / state.project.fps;
            const left = clip.startFrame * pixelsPerFrame;
            const width = Math.max(clip.durationFrames * pixelsPerFrame, 30);

            const clipEl = document.createElement('div');
            clipEl.className = 'timeline-clip' + (state.selectedClips.includes(clip.id) ? ' selected' : '');
            clipEl.style.left = left + 'px';
            clipEl.style.width = width + 'px';
            clipEl.style.background = clip.color;
            clipEl.dataset.clipId = clip.id;

            // Clip content
            let contentHTML = '';
            if (clip.type === 'audio') {
                contentHTML = `
                    <div class="clip-content">
                        <div class="waveform-container">
                            ${generateWaveform(Math.min(Math.floor(width / 3), 100))}
                        </div>
                    </div>
                `;
            } else {
                contentHTML = `
                    <div class="clip-content">
                        <span class="clip-name">${clip.name}</span>
                        ${width > 80 ? `<span class="clip-duration">${formatTimecode(clip.durationFrames)}</span>` : ''}
                    </div>
                `;
            }

            clipEl.innerHTML = contentHTML;

            // Resize handles
            const leftHandle = document.createElement('div');
            leftHandle.className = 'resize-handle left';
            leftHandle.onmousedown = (e) => { e.stopPropagation(); startResize(e, clip, 'left'); };

            const rightHandle = document.createElement('div');
            rightHandle.className = 'resize-handle right';
            rightHandle.onmousedown = (e) => { e.stopPropagation(); startResize(e, clip, 'right'); };

            clipEl.appendChild(leftHandle);
            clipEl.appendChild(rightHandle);

            // Keyframe track (if has keyframes)
            if (state.keyframes[clip.id] && Object.keys(state.keyframes[clip.id]).length > 0) {
                const kfTrack = document.createElement('div');
                kfTrack.className = 'keyframe-track';
                
                Object.values(state.keyframes[clip.id]).flat().forEach(kf => {
                    const marker = document.createElement('div');
                    marker.className = 'keyframe-marker';
                    marker.style.left = (kf.frame / clip.durationFrames * 100) + '%';
                    kfTrack.appendChild(marker);
                });
                
                clipEl.appendChild(kfTrack);
            }

            // Event listeners
            clipEl.onmousedown = (e) => handleClipMouseDown(e, clip);
            clipEl.ondblclick = () => showClipProperties(clip);

            return clipEl;
        }

        function generateWaveform(bars) {
            let html = '';
            for (let i = 0; i < bars; i++) {
                const height = 15 + Math.random() * 70;
                html += `<div class="waveform-bar" style="height: ${height}%"></div>`;
            }
            return html;
        }

        function renderTimeRuler() {
            const ruler = document.getElementById('timeRuler');
            ruler.innerHTML = '';

            const pixelsPerSecond = state.timeline.zoom;
            const totalSeconds = state.project.duration / state.project.fps;

            for (let s = 0; s <= totalSeconds; s++) {
                const marker = document.createElement('div');
                marker.className = 'absolute top-0 bottom-0';
                marker.style.left = (s * pixelsPerSecond) + 'px';
                marker.style.borderLeft = '1px solid #3a3a5a';

                const label = document.createElement('span');
                label.className = 'absolute top-1 left-1 text-[10px] text-muted';
                label.textContent = formatTimecode(s * state.project.fps);
                marker.appendChild(label);

                ruler.appendChild(marker);

                // Sub-markers
                if (pixelsPerSecond >= 40) {
                    for (let sub = 1; sub < 4; sub++) {
                        const subMarker = document.createElement('div');
                        subMarker.className = 'absolute top-3 bottom-0';
                        subMarker.style.left = ((s + sub * 0.25) * pixelsPerSecond) + 'px';
                        subMarker.style.borderLeft = '1px solid #2a2a40';
                        ruler.appendChild(subMarker);
                    }
                }
            }
        }

        function updatePlayhead() {
            const pixelsPerFrame = state.timeline.zoom / state.project.fps;
            const left = 140 + state.timeline.playheadPosition * pixelsPerFrame;
            document.getElementById('playhead').style.left = left + 'px';
            updateTimeDisplay();
        }

        function updateTimeDisplay() {
            document.getElementById('currentTime').textContent = formatTimecode(state.timeline.playheadPosition);
            document.getElementById('totalDuration').textContent = formatTimecode(state.project.duration);
        }

        function formatTimecode(frames) {
            const fps = state.project.fps;
            const totalSeconds = Math.floor(frames / fps);
            const f = Math.floor(frames % fps);
            const s = totalSeconds % 60;
            const m = Math.floor(totalSeconds / 60) % 60;
            const h = Math.floor(totalSeconds / 3600);
            return `${pad(h)}:${pad(m)}:${pad(s)}:${pad(f)}`;
        }

        function pad(n) {
            return n.toString().padStart(2, '0');
        }

        // ===== CLIP INTERACTION =====
        function handleClipMouseDown(e, clip) {
            e.stopPropagation();

            if (state.currentTool === 'razor') {
                splitClipAtPosition(clip, e.offsetX);
                return;
            }

            // Selection handling
            if (e.ctrlKey || e.metaKey) {
                if (state.selectedClips.includes(clip.id)) {
                    state.selectedClips = state.selectedClips.filter(id => id !== clip.id);
                } else {
                    state.selectedClips.push(clip.id);
                }
            } else if (!state.selectedClips.includes(clip.id)) {
                state.selectedClips = [clip.id];
            }

            renderTimeline();
            showClipProperties(clip);

            // Start dragging
            if (state.currentTool === 'select') {
                const track = state.tracks.find(t => t.id === clip.trackId);
                if (track && !track.locked) {
                    startClipDrag(e, clip);
                }
            }
        }

        function startClipDrag(e, clip) {
            const clipEl = e.target.closest('.timeline-clip');
            const rect = clipEl.getBoundingClientRect();

            dragData = {
                type: 'move',
                clip: clip,
                startX: e.clientX,
                startY: e.clientY,
                initialFrame: clip.startFrame,
                initialTrackId: clip.trackId,
                offsetX: e.clientX - rect.left
            };

            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('mouseup', handleDragEnd);
        }

        function startResize(e, clip, side) {
            dragData = {
                type: 'resize-' + side,
                clip: clip,
                startX: e.clientX,
                initialFrame: clip.startFrame,
                initialDuration: clip.durationFrames
            };

            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('mouseup', handleDragEnd);
        }

        function handleDragMove(e) {
            if (!dragData) return;

            const pixelsPerFrame = state.timeline.zoom / state.project.fps;
            const dx = e.clientX - dragData.startX;
            const framesDelta = Math.round(dx / pixelsPerFrame);

            if (dragData.type === 'move') {
                let newStart = Math.max(0, dragData.initialFrame + framesDelta);

                // Snapping
                if (state.timeline.snapping) {
                    const snapPoints = getSnapPoints(dragData.clip);
                    const clipEnd = newStart + dragData.clip.durationFrames;

                    for (const point of snapPoints) {
                        if (Math.abs(newStart - point) < 5) {
                            newStart = point;
                            showSnapGuide(point);
                            break;
                        }
                        if (Math.abs(clipEnd - point) < 5) {
                            newStart = point - dragData.clip.durationFrames;
                            showSnapGuide(point);
                            break;
                        }
                    }
                }

                dragData.clip.startFrame = newStart;
                renderTimeline();

            } else if (dragData.type === 'resize-left') {
                const newStart = Math.max(0, dragData.initialFrame + framesDelta);
                const delta = dragData.clip.startFrame - newStart;
                if (dragData.clip.durationFrames + delta > 10) {
                    dragData.clip.startFrame = newStart;
                    dragData.clip.durationFrames += delta;
                    if (dragData.clip.sourceIn !== undefined) {
                        dragData.clip.sourceIn = Math.max(0, dragData.clip.sourceIn - delta);
                    }
                }
                renderTimeline();

            } else if (dragData.type === 'resize-right') {
                const newDuration = Math.max(10, dragData.initialDuration + framesDelta);
                dragData.clip.durationFrames = newDuration;
                renderTimeline();
            }
        }

        function handleDragEnd() {
            hideSnapGuides();
            if (dragData) {
                saveState();
            }
            dragData = null;
            document.removeEventListener('mousemove', handleDragMove);
            document.removeEventListener('mouseup', handleDragEnd);
        }

        function getSnapPoints(excludeClip) {
            const points = [0, state.project.duration, state.timeline.playheadPosition];

            state.clips.forEach(clip => {
                if (clip.id !== excludeClip.id) {
                    points.push(clip.startFrame);
                    points.push(clip.startFrame + clip.durationFrames);
                }
            });

            return [...new Set(points)].sort((a, b) => a - b);
        }

        function showSnapGuide(frame) {
            hideSnapGuides();
            const pixelsPerFrame = state.timeline.zoom / state.project.fps;
            const left = 140 + frame * pixelsPerFrame;
            
            const guide = document.createElement('div');
            guide.className = 'absolute top-0 bottom-0 w-px bg-yellow-400 z-50 pointer-events-none';
            guide.style.left = left + 'px';
            guide.id = 'snapGuide';
            document.getElementById('tracksContainer').appendChild(guide);
        }

        function hideSnapGuides() {
            const existing = document.getElementById('snapGuide');
            if (existing) existing.remove();
        }

        // ===== PLAYBACK =====
        function togglePlayback() {
            if (state.timeline.isPlaying) {
                pausePlayback();
            } else {
                startPlayback();
            }
        }

        function startPlayback() {
            state.timeline.isPlaying = true;
            document.getElementById('playIcon').innerHTML = '<rect x="6" y="4" width="4" height="16" fill="currentColor"/><rect x="14" y="4" width="4" height="16" fill="currentColor"/>';
            document.getElementById('playBtn').classList.add('playing');
            lastFrameTime = performance.now();
            playbackLoop();
        }

        function pausePlayback() {
            state.timeline.isPlaying = false;
            document.getElementById('playIcon').innerHTML = '<path d="M8 5v14l11-7z"/>';
            document.getElementById('playBtn').classList.remove('playing');
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
        }

        function playbackLoop() {
            if (!state.timeline.isPlaying) return;

            const now = performance.now();
            const elapsed = now - lastFrameTime;
            const frameTime = 1000 / state.project.fps;

            if (elapsed >= frameTime) {
                state.timeline.playheadPosition++;

                if (state.timeline.playheadPosition >= state.project.duration) {
                    if (state.timeline.loop) {
                        state.timeline.playheadPosition = 0;
                    } else {
                        pausePlayback();
                        return;
                    }
                }

                updatePlayhead();
                renderPreview();
                lastFrameTime = now - (elapsed % frameTime);
            }

            animationFrame = requestAnimationFrame(playbackLoop);
        }

        function goToStart() {
            state.timeline.playheadPosition = 0;
            updatePlayhead();
            renderPreview();
        }

        function goToEnd() {
            state.timeline.playheadPosition = state.project.duration;
            updatePlayhead();
            renderPreview();
        }

        function previousFrame() {
            state.timeline.playheadPosition = Math.max(0, state.timeline.playheadPosition - 1);
            updatePlayhead();
            renderPreview();
        }

        function nextFrame() {
            state.timeline.playheadPosition = Math.min(state.project.duration, state.timeline.playheadPosition + 1);
            updatePlayhead();
            renderPreview();
        }

        function toggleLoop() {
            state.timeline.loop = !state.timeline.loop;
            document.getElementById('loopBtn').classList.toggle('active', state.timeline.loop);
            showToast(state.timeline.loop ? 'Loop enabled' : 'Loop disabled', 'info');
        }

        function toggleMute() {
            state.isMuted = !state.isMuted;
            const icon = state.isMuted 
                ? '<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>'
                : '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>';
            document.getElementById('volumeIcon').innerHTML = icon;
            document.getElementById('muteBtn').classList.toggle('active', state.isMuted);
        }

        function setMasterVolume(value) {
            state.masterVolume = parseInt(value);
        }

        // ===== SCRUBBING =====
        function startScrubbing(e) {
            scrubTo(e);
            document.addEventListener('mousemove', scrubTo);
            document.addEventListener('mouseup', stopScrubbing);
        }

        function scrubTo(e) {
            const ruler = document.getElementById('timeRuler');
            const rect = ruler.getBoundingClientRect();
            const x = Math.max(0, e.clientX - rect.left);
            const pixelsPerFrame = state.timeline.zoom / state.project.fps;
            const frame = Math.round(x / pixelsPerFrame);
            state.timeline.playheadPosition = Math.max(0, Math.min(state.project.duration, frame));
            updatePlayhead();
            renderPreview();
        }

        function stopScrubbing() {
            document.removeEventListener('mousemove', scrubTo);
            document.removeEventListener('mouseup', stopScrubbing);
        }

        function scrubTimeline(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const pixelsPerFrame = state.timeline.zoom / state.project.fps;
            const frame = Math.round(x / pixelsPerFrame);
            state.timeline.playheadPosition = Math.max(0, Math.min(state.project.duration, frame));
            updatePlayhead();
            renderPreview();
        }

        function handleTimelineClick(e) {
            if (e.target.id === 'tracksContainer' || e.target.id === 'tracksWrapper') {
                // Click on empty area - deselect
                if (!e.ctrlKey && !e.metaKey) {
                    deselectAll();
                }
            }
        }

        // ===== PREVIEW RENDERING =====
        function renderPreview() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const frame = state.timeline.playheadPosition;

            // Get visible clips at current frame (sorted by track order - bottom first)
            const visibleClips = state.clips
                .filter(clip => {
                    if (clip.type === 'audio') return false;
                    const track = state.tracks.find(t => t.id === clip.trackId);
                    if (!track || !track.visible) return false;
                    return clip.startFrame <= frame && clip.startFrame + clip.durationFrames > frame;
                })
                .sort((a, b) => {
                    const trackA = state.tracks.findIndex(t => t.id === a.trackId);
                    const trackB = state.tracks.findIndex(t => t.id === b.trackId);
                    return trackB - trackA;
                });

            // Render each clip
            visibleClips.forEach(clip => {
                ctx.save();

                const t = clip.transform || { x: 0, y: 0, scale: 1, rotation: 0, opacity: 1 };
                const clipFrame = frame - clip.startFrame;

                // Apply keyframe animations if any
                const animatedTransform = getAnimatedTransform(clip, clipFrame);
                const finalT = { ...t, ...animatedTransform };

                // Apply color adjustments
                applyColorFilters(ctx);

                ctx.globalAlpha = finalT.opacity;
                ctx.translate(canvas.width / 2 + finalT.x, canvas.height / 2 + finalT.y);
                ctx.rotate(finalT.rotation * Math.PI / 180);
                ctx.scale(finalT.scale, finalT.scale);

                if (clip.type === 'video') {
                    // Draw video placeholder
                    const gradient = ctx.createLinearGradient(-canvas.width/2, -canvas.height/2, canvas.width/2, canvas.height/2);
                    gradient.addColorStop(0, clip.color + 'CC');
                    gradient.addColorStop(1, clip.color + '66');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(-canvas.width / 2, -canvas.height / 2, canvas.width, canvas.height);

                    // Clip info
                    ctx.fillStyle = '#ffffff';
                    ctx.font = 'bold 48px Inter, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(clip.name, 0, -30);

                    ctx.font = '24px Inter, sans-serif';
                    ctx.fillStyle = 'rgba(255,255,255,0.7)';
                    ctx.fillText(`Frame ${clipFrame + 1} / ${clip.durationFrames}`, 0, 30);

                } else if (clip.type === 'text') {
                    ctx.fillStyle = clip.textColor || '#ffffff';
                    ctx.font = `${clip.fontWeight || 400} ${clip.fontSize || 48}px ${clip.fontFamily || 'Inter'}, sans-serif`;
                    ctx.textAlign = clip.textAlign || 'center';
                    ctx.textBaseline = 'middle';

                    // Apply text animation
                    if (clip.animation) {
                        applyTextAnimation(ctx, clip, clipFrame);
                    }

                    ctx.fillText(clip.text || 'Text', 0, 0);
                }

                ctx.restore();
            });

            // Apply global filter
            applyGlobalFilter();

            // Draw vignette if enabled
            if (state.colorAdjustments.vignette > 0) {
                drawVignette();
            }
        }

        function getAnimatedTransform(clip, frame) {
            const kfs = state.keyframes[clip.id];
            if (!kfs) return {};

            const result = {};
            ['x', 'y', 'scale', 'rotation', 'opacity'].forEach(prop => {
                if (kfs[prop] && kfs[prop].length > 0) {
                    result[prop] = interpolateKeyframes(kfs[prop], frame);
                }
            });
            return result;
        }

        function interpolateKeyframes(keyframes, frame) {
            if (keyframes.length === 0) return undefined;
            if (keyframes.length === 1) return keyframes[0].value;

            // Sort by frame
            const sorted = [...keyframes].sort((a, b) => a.frame - b.frame);

            // Before first keyframe
            if (frame <= sorted[0].frame) return sorted[0].value;

            // After last keyframe
            if (frame >= sorted[sorted.length - 1].frame) return sorted[sorted.length - 1].value;

            // Find surrounding keyframes
            for (let i = 0; i < sorted.length - 1; i++) {
                if (frame >= sorted[i].frame && frame <= sorted[i + 1].frame) {
                    const t = (frame - sorted[i].frame) / (sorted[i + 1].frame - sorted[i].frame);
                    return lerp(sorted[i].value, sorted[i + 1].value, easeInOutCubic(t));
                }
            }

            return sorted[0].value;
        }

        function lerp(a, b, t) {
            return a + (b - a) * t;
        }

        function easeInOutCubic(t) {
            return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
        }

        function applyColorFilters(ctx) {
            // In a real implementation, this would use canvas filters or WebGL
            // For demo purposes, we'll just note where filters would be applied
        }

        function applyGlobalFilter() {
            if (state.currentFilter === 'none') return;

            // Apply canvas-based filters
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            switch (state.currentFilter) {
                case 'bw':
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        data[i] = data[i + 1] = data[i + 2] = avg;
                    }
                    break;
                case 'vintage':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] * 1.1);
                        data[i + 1] = data[i + 1] * 0.9;
                        data[i + 2] = data[i + 2] * 0.8;
                    }
                    break;
                case 'cool':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = data[i] * 0.9;
                        data[i + 2] = Math.min(255, data[i + 2] * 1.2);
                    }
                    break;
                case 'warm':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] * 1.2);
                        data[i + 2] = data[i + 2] * 0.8;
                    }
                    break;
            }

            ctx.putImageData(imageData, 0, 0);
        }

        function drawVignette() {
            const strength = state.colorAdjustments.vignette / 100;
            const gradient = ctx.createRadialGradient(
                canvas.width / 2, canvas.height / 2, canvas.width * 0.2,
                canvas.width / 2, canvas.height / 2, canvas.width * 0.7
            );
            gradient.addColorStop(0, 'transparent');
            gradient.addColorStop(1, `rgba(0,0,0,${strength})`);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function applyTextAnimation(ctx, clip, frame) {
            const duration = 30; // Animation duration in frames
            const progress = Math.min(frame / duration, 1);

            switch (clip.animation) {
                case 'fadeIn':
                    ctx.globalAlpha *= progress;
                    break;
                case 'slideUp':
                    ctx.translate(0, 50 * (1 - easeInOutCubic(progress)));
                    ctx.globalAlpha *= progress;
                    break;
                case 'zoomIn':
                    const scale = 0.5 + 0.5 * easeInOutCubic(progress);
                    ctx.scale(scale, scale);
                    ctx.globalAlpha *= progress;
                    break;
                case 'bounce':
                    const bounce = Math.sin(progress * Math.PI) * (1 - progress) * 30;
                    ctx.translate(0, -bounce);
                    break;
            }
        }

        // ===== EDITING TOOLS =====
        function setTool(tool) {
            state.currentTool = tool;
            document.querySelectorAll('#selectTool, #razorTool, #handTool').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(tool + 'Tool').classList.add('active');

            const container = document.getElementById('tracksContainer');
            container.style.cursor = tool === 'hand' ? 'grab' : tool === 'razor' ? 'crosshair' : 'default';
        }

        function splitAtPlayhead() {
            const frame = state.timeline.playheadPosition;
            let splitCount = 0;

            const clipsToSplit = state.selectedClips.length > 0 
                ? state.clips.filter(c => state.selectedClips.includes(c.id))
                : state.clips.filter(c => c.startFrame < frame && c.startFrame + c.durationFrames > frame);

            clipsToSplit.forEach(clip => {
                if (clip.startFrame < frame && clip.startFrame + clip.durationFrames > frame) {
                    const splitPoint = frame - clip.startFrame;

                    const newClip = {
                        ...JSON.parse(JSON.stringify(clip)),
                        id: 'clip_' + (++clipIdCounter),
                        startFrame: frame,
                        durationFrames: clip.durationFrames - splitPoint,
                        sourceIn: (clip.sourceIn || 0) + splitPoint,
                        name: clip.name + ' (2)'
                    };

                    clip.durationFrames = splitPoint;
                    clip.sourceOut = (clip.sourceIn || 0) + splitPoint;

                    state.clips.push(newClip);
                    splitCount++;
                }
            });

            if (splitCount > 0) {
                renderTimeline();
                saveState();
                showToast(`Split ${splitCount} clip${splitCount > 1 ? 's' : ''}`, 'success');
            }
        }

        function splitClipAtPosition(clip, offsetX) {
            const pixelsPerFrame = state.timeline.zoom / state.project.fps;
            const splitFrame = clip.startFrame + Math.round(offsetX / pixelsPerFrame);

            if (splitFrame > clip.startFrame && splitFrame < clip.startFrame + clip.durationFrames) {
                const splitPoint = splitFrame - clip.startFrame;

                const newClip = {
                    ...JSON.parse(JSON.stringify(clip)),
                    id: 'clip_' + (++clipIdCounter),
                    startFrame: splitFrame,
                    durationFrames: clip.durationFrames - splitPoint,
                    sourceIn: (clip.sourceIn || 0) + splitPoint,
                    name: clip.name + ' (2)'
                };

                clip.durationFrames = splitPoint;
                state.clips.push(newClip);

                renderTimeline();
                saveState();
                showToast('Clip split', 'success');
            }
        }

        function deleteSelected() {
            if (state.selectedClips.length === 0) {
                showToast('No clips selected', 'warning');
                return;
            }

            const count = state.selectedClips.length;
            state.clips = state.clips.filter(c => !state.selectedClips.includes(c.id));
            state.selectedClips = [];

            renderTimeline();
            renderPreview();
            saveState();
            showDefaultProperties();
            showToast(`Deleted ${count} clip${count > 1 ? 's' : ''}`, 'success');
        }

        function duplicateSelected() {
            if (state.selectedClips.length === 0) {
                showToast('No clips selected', 'warning');
                return;
            }

            const newClips = [];
            state.selectedClips.forEach(clipId => {
                const clip = state.clips.find(c => c.id === clipId);
                if (clip) {
                    const newClip = {
                        ...JSON.parse(JSON.stringify(clip)),
                        id: 'clip_' + (++clipIdCounter),
                        startFrame: clip.startFrame + clip.durationFrames,
                        name: clip.name + ' (copy)'
                    };
                    newClips.push(newClip);
                }
            });

            state.clips.push(...newClips);
            state.selectedClips = newClips.map(c => c.id);

            renderTimeline();
            saveState();
            showToast(`Duplicated ${newClips.length} clip${newClips.length > 1 ? 's' : ''}`, 'success');
        }

        function selectAll() {
            state.selectedClips = state.clips.map(c => c.id);
            renderTimeline();
            showToast('Selected all clips', 'info');
        }

        function deselectAll() {
            state.selectedClips = [];
            renderTimeline();
            showDefaultProperties();
        }

        function copyClip() {
            if (state.selectedClips.length === 0) return;
            state.clipboard = state.selectedClips.map(id => {
                const clip = state.clips.find(c => c.id === id);
                return clip ? JSON.parse(JSON.stringify(clip)) : null;
            }).filter(Boolean);
            showToast('Copied to clipboard', 'info');
        }

        function cutClip() {
            copyClip();
            deleteSelected();
        }

        function pasteClip() {
            if (!state.clipboard || state.clipboard.length === 0) {
                showToast('Nothing to paste', 'warning');
                return;
            }

            const newClips = state.clipboard.map(clip => ({
                ...clip,
                id: 'clip_' + (++clipIdCounter),
                startFrame: state.timeline.playheadPosition
            }));

            state.clips.push(...newClips);
            state.selectedClips = newClips.map(c => c.id);

            renderTimeline();
            saveState();
            showToast(`Pasted ${newClips.length} clip${newClips.length > 1 ? 's' : ''}`, 'success');
        }

        function reverseClip() {
            state.selectedClips.forEach(clipId => {
                const clip = state.clips.find(c => c.id === clipId);
                if (clip) {
                    clip.reversed = !clip.reversed;
                    clip.name = clip.reversed ? clip.name + ' (R)' : clip.name.replace(' (R)', '');
                }
            });
            renderTimeline();
            saveState();
            showToast('Clip reversed', 'success');
        }

        function freezeFrame() {
            const frame = state.timeline.playheadPosition;
            
            state.selectedClips.forEach(clipId => {
                const clip = state.clips.find(c => c.id === clipId);
                if (clip && clip.startFrame <= frame && clip.startFrame + clip.durationFrames > frame) {
                    const freezeClip = {
                        ...JSON.parse(JSON.stringify(clip)),
                        id: 'clip_' + (++clipIdCounter),
                        name: 'Freeze Frame',
                        type: 'video',
                        startFrame: frame,
                        durationFrames: 30,
                        color: '#f59e0b'
                    };
                    state.clips.push(freezeClip);
                }
            });

            renderTimeline();
            saveState();
            showToast('Freeze frame added', 'success');
        }

        // ===== TIMELINE CONTROLS =====
        function setTimelineZoom(value) {
            state.timeline.zoom = parseInt(value);
            document.getElementById('zoomLevel').textContent = value + '%';
            renderTimeline();
            renderTimeRuler();
        }

        function zoomTimeline(delta) {
            const slider = document.getElementById('zoomSlider');
            const newValue = Math.max(10, Math.min(200, parseInt(slider.value) + delta));
            slider.value = newValue;
            setTimelineZoom(newValue);
        }

        function toggleSnapping() {
            state.timeline.snapping = !state.timeline.snapping;
            document.getElementById('snapBtn').classList.toggle('active', state.timeline.snapping);
            showToast(state.timeline.snapping ? 'Snapping enabled' : 'Snapping disabled', 'info');
        }

        // ===== TRACK CONTROLS =====
        function toggleTrackMute(trackId) {
            const track = state.tracks.find(t => t.id === trackId);
            if (track) {
                track.muted = !track.muted;
                renderTimeline();
            }
        }

        function toggleTrackLock(trackId) {
            const track = state.tracks.find(t => t.id === trackId);
            if (track) {
                track.locked = !track.locked;
                renderTimeline();
            }
        }

        function toggleTrackVisibility(trackId) {
            const track = state.tracks.find(t => t.id === trackId);
            if (track) {
                track.visible = !track.visible;
                renderTimeline();
                renderPreview();
            }
        }

        function addTrack(type) {
            const id = type.charAt(0) + (++trackIdCounter);
            const name = type.charAt(0).toUpperCase() + type.slice(1) + ' ' + trackIdCounter;
            
            const newTrack = {
                id,
                name,
                type,
                height: type === 'video' ? 50 : 40,
                muted: false,
                locked: false,
                visible: true
            };

            // Insert at appropriate position
            const typeOrder = { video: 0, text: 1, audio: 2 };
            let insertIndex = state.tracks.length;
            for (let i = 0; i < state.tracks.length; i++) {
                if (typeOrder[state.tracks[i].type] > typeOrder[type]) {
                    insertIndex = i;
                    break;
                }
            }

            state.tracks.splice(insertIndex, 0, newTrack);
            renderTimeline();
            showToast(`Added ${type} track`, 'success');
        }

        // ===== PROPERTIES PANEL =====
        function showClipProperties(clip) {
            document.getElementById('propertiesTitle').textContent = clip.name;
            const panel = document.getElementById('propertiesPanel');

            let html = '<div class="space-y-4">';

            // Basic Info
            html += `
                <div class="panel-section">
                    <div class="panel-header">Basic Info</div>
                    <div class="panel-content">
                        <div class="form-group">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-input" value="${clip.name}" onchange="updateClipName('${clip.id}', this.value)">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <div class="text-xs text-muted mb-1">Start</div>
                                <div class="text-sm font-mono">${formatTimecode(clip.startFrame)}</div>
                            </div>
                            <div>
                                <div class="text-xs text-muted mb-1">Duration</div>
                                <div class="text-sm font-mono">${formatTimecode(clip.durationFrames)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Transform (for video/text)
            if (clip.type === 'video' || clip.type === 'text') {
                const t = clip.transform || { x: 0, y: 0, scale: 1, rotation: 0, opacity: 1 };
                html += `
                    <div class="panel-section">
                        <div class="panel-header">Transform</div>
                        <div class="panel-content space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div class="form-group m-0">
                                    <label class="form-label">X Position</label>
                                    <input type="number" class="form-input" value="${t.x}" onchange="updateClipTransform('${clip.id}', 'x', this.value)">
                                </div>
                                <div class="form-group m-0">
                                    <label class="form-label">Y Position</label>
                                    <input type="number" class="form-input" value="${t.y}" onchange="updateClipTransform('${clip.id}', 'y', this.value)">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="form-group m-0">
                                    <label class="form-label">Scale</label>
                                    <input type="number" class="form-input" value="${t.scale}" step="0.1" min="0.1" max="5" onchange="updateClipTransform('${clip.id}', 'scale', this.value)">
                                </div>
                                <div class="form-group m-0">
                                    <label class="form-label">Rotation</label>
                                    <input type="number" class="form-input" value="${t.rotation}" onchange="updateClipTransform('${clip.id}', 'rotation', this.value)">
                                </div>
                            </div>
                            <div class="form-group m-0">
                                <label class="form-label flex justify-between">
                                    <span>Opacity</span>
                                    <span>${Math.round(t.opacity * 100)}%</span>
                                </label>
                                <input type="range" min="0" max="1" step="0.05" value="${t.opacity}" oninput="updateClipTransform('${clip.id}', 'opacity', this.value); this.previousElementSibling.lastElementChild.textContent = Math.round(this.value * 100) + '%'">
                            </div>
                        </div>
                    </div>
                `;
            }

            // Speed
            if (clip.type === 'video') {
                html += `
                    <div class="panel-section">
                        <div class="panel-header">Speed</div>
                        <div class="panel-content">
                            <div class="flex items-center gap-3">
                                <input type="range" class="flex-1" min="0.1" max="4" step="0.1" value="${clip.speed || 1}" oninput="updateClipSpeed('${clip.id}', this.value); this.nextElementSibling.textContent = parseFloat(this.value).toFixed(1) + 'x'">
                                <span class="text-sm font-medium w-12">${(clip.speed || 1).toFixed(1)}x</span>
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button class="btn btn-secondary btn-sm flex-1" onclick="updateClipSpeed('${clip.id}', 0.5)">0.5x</button>
                                <button class="btn btn-secondary btn-sm flex-1" onclick="updateClipSpeed('${clip.id}', 1)">1x</button>
                                <button class="btn btn-secondary btn-sm flex-1" onclick="updateClipSpeed('${clip.id}', 2)">2x</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Text Properties
            if (clip.type === 'text') {
                html += `
                    <div class="panel-section">
                        <div class="panel-header">Text</div>
                        <div class="panel-content space-y-3">
                            <div class="form-group m-0">
                                <label class="form-label">Content</label>
                                <textarea class="form-input" rows="2" onchange="updateClipText('${clip.id}', this.value)">${clip.text || ''}</textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="form-group m-0">
                                    <label class="form-label">Font Size</label>
                                    <input type="number" class="form-input" value="${clip.fontSize || 48}" min="8" max="200" onchange="updateClipFontSize('${clip.id}', this.value)">
                                </div>
                                <div class="form-group m-0">
                                    <label class="form-label">Font</label>
                                    <select class="form-select" onchange="updateClipFont('${clip.id}', this.value)">
                                        <option value="Inter" ${clip.fontFamily === 'Inter' ? 'selected' : ''}>Inter</option>
                                        <option value="Poppins" ${clip.fontFamily === 'Poppins' ? 'selected' : ''}>Poppins</option>
                                        <option value="Montserrat" ${clip.fontFamily === 'Montserrat' ? 'selected' : ''}>Montserrat</option>
                                        <option value="Bebas Neue" ${clip.fontFamily === 'Bebas Neue' ? 'selected' : ''}>Bebas Neue</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group m-0">
                                <label class="form-label">Color</label>
                                <input type="color" class="w-full h-10 rounded cursor-pointer" value="${clip.textColor || '#ffffff'}" onchange="updateClipTextColor('${clip.id}', this.value)">
                            </div>
                            <div class="form-group m-0">
                                <label class="form-label">Animation</label>
                                <select class="form-select" onchange="updateClipAnimation('${clip.id}', this.value)">
                                    <option value="" ${!clip.animation ? 'selected' : ''}>None</option>
                                    <option value="fadeIn" ${clip.animation === 'fadeIn' ? 'selected' : ''}>Fade In</option>
                                    <option value="slideUp" ${clip.animation === 'slideUp' ? 'selected' : ''}>Slide Up</option>
                                    <option value="zoomIn" ${clip.animation === 'zoomIn' ? 'selected' : ''}>Zoom In</option>
                                    <option value="bounce" ${clip.animation === 'bounce' ? 'selected' : ''}>Bounce</option>
                                    <option value="typewriter" ${clip.animation === 'typewriter' ? 'selected' : ''}>Typewriter</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Audio Properties
            if (clip.type === 'audio') {
                html += `
                    <div class="panel-section">
                        <div class="panel-header">Audio</div>
                        <div class="panel-content space-y-3">
                            <div class="form-group m-0">
                                <label class="form-label flex justify-between">
                                    <span>Volume</span>
                                    <span>${Math.round((clip.volume || 1) * 100)}%</span>
                                </label>
                                <input type="range" min="0" max="2" step="0.05" value="${clip.volume || 1}" oninput="updateClipVolume('${clip.id}', this.value); this.previousElementSibling.lastElementChild.textContent = Math.round(this.value * 100) + '%'">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="form-group m-0">
                                    <label class="form-label">Fade In (s)</label>
                                    <input type="number" class="form-input" value="${clip.fadeIn || 0}" min="0" step="0.1" onchange="updateClipFade('${clip.id}', 'fadeIn', this.value)">
                                </div>
                                <div class="form-group m-0">
                                    <label class="form-label">Fade Out (s)</label>
                                    <input type="number" class="form-input" value="${clip.fadeOut || 0}" min="0" step="0.1" onchange="updateClipFade('${clip.id}', 'fadeOut', this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Keyframes
            html += `
                <div class="panel-section">
                    <div class="panel-header">Keyframes</div>
                    <div class="panel-content">
                        <div class="grid grid-cols-2 gap-2">
                            <button class="btn btn-secondary btn-sm" onclick="addKeyframe('x', '${clip.id}')">+ Position X</button>
                            <button class="btn btn-secondary btn-sm" onclick="addKeyframe('y', '${clip.id}')">+ Position Y</button>
                            <button class="btn btn-secondary btn-sm" onclick="addKeyframe('scale', '${clip.id}')">+ Scale</button>
                            <button class="btn btn-secondary btn-sm" onclick="addKeyframe('rotation', '${clip.id}')">+ Rotation</button>
                            <button class="btn btn-secondary btn-sm" onclick="addKeyframe('opacity', '${clip.id}')">+ Opacity</button>
                        </div>
                    </div>
                </div>
            `;

            // Color (for selected clip)
            html += `
                <div class="panel-section">
                    <div class="panel-header">Clip Color</div>
                    <div class="panel-content">
                        <div class="flex gap-2 flex-wrap">
                            ${['#8b5cf6', '#ec4899', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#6366f1'].map(color => `
                                <div class="w-8 h-8 rounded-lg cursor-pointer transition hover:scale-110 ${clip.color === color ? 'ring-2 ring-white ring-offset-2 ring-offset-gray-900' : ''}" 
                                     style="background: ${color}" 
                                     onclick="updateClipColor('${clip.id}', '${color}')"></div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            html += '</div>';
            panel.innerHTML = html;
        }

        function showDefaultProperties() {
            document.getElementById('propertiesTitle').textContent = 'Properties';
            document.getElementById('propertiesPanel').innerHTML = `
                <div class="text-center py-12 text-muted">
                    <svg class="w-16 h-16 mx-auto mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>
                    <p class="text-sm">Select a clip to edit its properties</p>
                </div>
            `;
        }

        // Property update functions
        function updateClipName(clipId, value) {
            const clip = state.clips.find(c => c.id === clipId);
            if (clip) { clip.name = value; renderTimeline(); saveState(); }
        }

        function updateClipTransform(clipId, prop, value) {
            const clip = state.clips.find(c => c.id === clipId);
            if (clip) {
                if (!clip.transform) clip.transform = { x: 0, y: 0, scale: 1, rotation: 0, opacity: 1 };
                clip.transform[prop] = parseFloat(value);
                renderPreview();
                saveState();
            }
        }

        function updateClipSpeed(clipId, value) {
            const clip = state.clips.find(c => c.id === clipId);
            if (clip) {
                clip.speed = parseFloat(value);
                showClipProperties(clip);
                saveState();
            }
        }

        function updateClipText(clipId, value) {
            const clip = state.clips.find(c => c.id === clipId);
            if (clip) { clip.text = value; renderPreview(); saveState(); }
        }

        function updateClipFontSize(clipId, value) {
            const clip = state.clips.find(c => c.id === clipId);
            if (clip) { clip.fontSize = parseInt(value); renderPreview(); saveState(); }
        }

        function updateClipFont(clipId, value) {
            const clip = state.clips.find(c => c.id === clipId);
            if (clip) { clip.fontFamily = value; renderPreview(); saveState(); }
        }

        function updateClipTextColor(clipId, value) {
            const clip = state.clips.find(c => c.id === clipId);
            if (clip) { clip.textColor = value; renderPreview(); saveState(); }
        }

        function updateClipAnimation(clipId, value) {
            const clip = state.clips.find(c => c.id === clipId);
            if (clip) { clip.animation = value || null; renderPreview(); saveState(); }
        }

        function updateClipVolume(clipId, value) {
            const clip = state.clips.find(c => c.id === clipId);
            if (clip) { clip.volume = parseFloat(value); saveState(); }
        }

        function updateClipFade(clipId, prop, value) {
            const clip = state.clips.find(c => c.id === clipId);
            if (clip) { clip[prop] = parseFloat(value); saveState(); }
        }

        function updateClipColor(clipId, color) {
            const clip = state.clips.find(c => c.id === clipId);
            if (clip) {
                clip.color = color;
                renderTimeline();
                showClipProperties(clip);
                saveState();
            }
        }

        function addKeyframe(property, clipId) {
            const id = clipId || (state.selectedClips.length > 0 ? state.selectedClips[0] : null);
            if (!id) return;

            const clip = state.clips.find(c => c.id === id);
            if (!clip) return;

            if (!state.keyframes[id]) state.keyframes[id] = {};
            if (!state.keyframes[id][property]) state.keyframes[id][property] = [];

            const localFrame = state.timeline.playheadPosition - clip.startFrame;
            if (localFrame < 0 || localFrame >= clip.durationFrames) {
                showToast('Playhead must be within clip', 'warning');
                return;
            }

            const t = clip.transform || { x: 0, y: 0, scale: 1, rotation: 0, opacity: 1 };
            const value = t[property] !== undefined ? t[property] : 0;

            state.keyframes[id][property].push({
                frame: localFrame,
                value: value,
                easing: 'ease-in-out'
            });

            renderTimeline();
            saveState();
            showToast(`Keyframe added for ${property}`, 'success');
        }

        // ===== PANEL SWITCHING =====
        function switchPanel(panelName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.panel === panelName);
            });
            document.querySelectorAll('.panel-container').forEach(panel => {
                panel.classList.toggle('hidden', panel.id !== 'panel-' + panelName);
            });
        }

        // ===== FILE/MEDIA HANDLING =====
        function handleFileImport(event) {
            const files = event.target.files;
            importFiles(files);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('border-purple-500', 'bg-purple-500/10');
        }

        function handleFileDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('border-purple-500', 'bg-purple-500/10');
            const files = event.dataTransfer.files;
            importFiles(files);
        }

        function importFiles(files) {
            Array.from(files).forEach(file => {
                const type = file.type.startsWith('video') ? 'video' :
                            file.type.startsWith('audio') ? 'audio' : 'image';

                const mediaItem = {
                    id: 'media_' + Date.now() + Math.random().toString(36).substr(2, 9),
                    name: file.name,
                    type: type,
                    file: file,
                    url: URL.createObjectURL(file),
                    duration: 150,
                    thumbnail: null
                };

                state.mediaLibrary.push(mediaItem);
            });

            renderMediaLibrary();
            showToast(`Imported ${files.length} file${files.length > 1 ? 's' : ''}`, 'success');
        }

        function renderMediaLibrary() {
            const container = document.getElementById('mediaLibrary');
            document.getElementById('mediaCount').textContent = state.mediaLibrary.length + ' items';

            if (state.mediaLibrary.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 col-span-2 text-muted text-sm">
                        <svg class="w-12 h-12 mx-auto mb-2 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                        No media imported yet
                    </div>
                `;
                return;
            }

            container.innerHTML = state.mediaLibrary.map(item => `
                <div class="aspect-video bg-[#252540] rounded-lg overflow-hidden cursor-pointer hover:ring-2 ring-purple-500 transition relative group"
                     draggable="true"
                     ondragstart="dragMedia(event, '${item.id}')"
                     ondblclick="addMediaToTimeline('${item.id}')">
                    <div class="absolute inset-0 flex items-center justify-center">
                        ${item.type === 'video' ? '<svg class="w-8 h-8 text-purple-400" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>' :
                          item.type === 'audio' ? '<svg class="w-8 h-8 text-green-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>' :
                          '<svg class="w-8 h-8 text-blue-400" fill="currentColor" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>'}
                    </div>
                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 p-2">
                        <div class="text-[10px] truncate">${item.name}</div>
                    </div>
                    <div class="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition">
                        <button class="w-6 h-6 bg-red-500 rounded flex items-center justify-center text-white" onclick="event.stopPropagation(); removeMedia('${item.id}')">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function dragMedia(event, mediaId) {
            event.dataTransfer.setData('mediaId', mediaId);
        }

        function handleTrackDrop(event, trackId) {
            event.preventDefault();
            const mediaId = event.dataTransfer.getData('mediaId');
            if (mediaId) {
                addMediaToTimeline(mediaId, trackId);
            }
        }

        function addMediaToTimeline(mediaId, targetTrackId) {
            const media = state.mediaLibrary.find(m => m.id === mediaId);
            if (!media) return;

            const trackId = targetTrackId || (media.type === 'audio' ? 'a1' : 'v1');
            const colors = {
                video: '#8b5cf6',
                audio: '#22c55e',
                image: '#3b82f6'
            };

            const newClip = {
                id: 'clip_' + (++clipIdCounter),
                trackId: trackId,
                name: media.name.replace(/\.[^/.]+$/, ''),
                type: media.type === 'image' ? 'video' : media.type,
                color: colors[media.type],
                startFrame: state.timeline.playheadPosition,
                durationFrames: media.duration,
                sourceIn: 0,
                sourceOut: media.duration,
                speed: 1,
                volume: 1,
                transform: { x: 0, y: 0, scale: 1, rotation: 0, opacity: 1 },
                mediaId: media.id
            };

            state.clips.push(newClip);
            state.selectedClips = [newClip.id];
            renderTimeline();
            renderPreview();
            showClipProperties(newClip);
            saveState();
            showToast('Added to timeline', 'success');
        }

        function removeMedia(mediaId) {
            state.mediaLibrary = state.mediaLibrary.filter(m => m.id !== mediaId);
            renderMediaLibrary();
        }

        function handleAudioImport(event) {
            handleFileImport(event);
        }

        // ===== TEXT & ELEMENTS =====
        function addText() {
            addTextStyle('body');
        }

        function addTextStyle(style) {
            const styles = {
                title: { text: 'Title', fontSize: 96, fontWeight: 700 },
                subtitle: { text: 'Subtitle', fontSize: 48, fontWeight: 600 },
                body: { text: 'Enter text here', fontSize: 36, fontWeight: 400 },
                caption: { text: 'Caption', fontSize: 24, fontWeight: 400 },
                lowerThird: { text: 'Name Here', fontSize: 32, fontWeight: 600 }
            };

            const s = styles[style] || styles.body;
            const newClip = {
                id: 'clip_' + (++clipIdCounter),
                trackId: 't1',
                name: style.charAt(0).toUpperCase() + style.slice(1),
                type: 'text',
                color: '#fbbf24',
                startFrame: state.timeline.playheadPosition,
                durationFrames: 90,
                text: s.text,
                fontSize: s.fontSize,
                fontWeight: s.fontWeight,
                fontFamily: 'Inter',
                textColor: '#ffffff',
                textAlign: 'center',
                animation: null,
                transform: { x: 0, y: 0, scale: 1, rotation: 0, opacity: 1 }
            };

            state.clips.push(newClip);
            state.selectedClips = [newClip.id];
            renderTimeline();
            renderPreview();
            showClipProperties(newClip);
            saveState();
            showToast('Text added', 'success');
        }

        function addTextAnimation(animation) {
            state.selectedClips.forEach(clipId => {
                const clip = state.clips.find(c => c.id === clipId);
                if (clip && clip.type === 'text') {
                    clip.animation = animation;
                }
            });
            renderPreview();
            saveState();
            showToast(`Animation applied: ${animation}`, 'success');
        }

        function generateCaptions() {
            showToast('Generating captions... (AI feature - demo)', 'info');
            // In a real implementation, this would use speech-to-text API
            setTimeout(() => {
                showToast('Captions generated!', 'success');
            }, 2000);
        }

        function dragElement(event, type, data) {
            event.dataTransfer.setData('elementType', type);
            event.dataTransfer.setData('elementData', data);
        }

        function addShape(shapeType) {
            const newClip = {
                id: 'clip_' + (++clipIdCounter),
                trackId: 'v2',
                name: shapeType.charAt(0).toUpperCase() + shapeType.slice(1),
                type: 'shape',
                shapeType: shapeType,
                color: '#ffffff',
                fillColor: '#8b5cf6',
                startFrame: state.timeline.playheadPosition,
                durationFrames: 90,
                transform: { x: 0, y: 0, scale: 1, rotation: 0, opacity: 1 }
            };

            state.clips.push(newClip);
            renderTimeline();
            renderPreview();
            saveState();
            showToast(`${shapeType} added`, 'success');
        }

        function addOverlay(overlayType) {
            showToast(`Overlay added: ${overlayType}`, 'success');
        }

        // ===== EFFECTS & FILTERS =====
        function applyFilter(filterName) {
            state.currentFilter = filterName;
            
            // Update UI
            document.querySelectorAll('[data-filter]').forEach(card => {
                card.classList.toggle('active', card.dataset.filter === filterName);
            });

            // Apply to selected clips or globally
            if (state.selectedClips.length > 0) {
                state.selectedClips.forEach(clipId => {
                    const clip = state.clips.find(c => c.id === clipId);
                    if (clip) clip.filter = filterName;
                });
            }

            renderPreview();
            showToast(`Filter applied: ${filterName}`, 'success');
        }

        function updateAdjustment(name, value) {
            state.colorAdjustments[name] = parseInt(value);
            document.getElementById(name + 'Value').textContent = value;
            renderPreview();
        }

        function resetColorAdjustments() {
            Object.keys(state.colorAdjustments).forEach(key => {
                state.colorAdjustments[key] = 0;
                const el = document.getElementById(key);
                if (el) el.value = 0;
                const valueEl = document.getElementById(key + 'Value');
                if (valueEl) valueEl.textContent = '0';
            });
            renderPreview();
            showToast('Adjustments reset', 'info');
        }

        function addEffect(effectName) {
            showToast(`Effect applied: ${effectName}`, 'success');
        }

        function selectTransition(transitionName) {
            state.timeline.selectedTransition = transitionName;
        }

        function removeBackground() {
            showToast('Removing background... (AI feature - demo)', 'info');
        }

        function autoReframe() {
            showToast('Auto reframing... (AI feature - demo)', 'info');
        }

        function stabilizeVideo() {
            showToast('Stabilizing video... (AI feature - demo)', 'info');
        }

        // ===== AUDIO =====
        function addMusic(trackName) {
            const newClip = {
                id: 'clip_' + (++clipIdCounter),
                trackId: 'a3',
                name: trackName.charAt(0).toUpperCase() + trackName.slice(1) + ' Music',
                type: 'audio',
                color: '#22c55e',
                startFrame: state.timeline.playheadPosition,
                durationFrames: 180,
                volume: 0.7,
                fadeIn: 0.5,
                fadeOut: 1
            };

            state.clips.push(newClip);
            renderTimeline();
            saveState();
            showToast('Music added', 'success');
        }

        function addSFX(sfxName) {
            const newClip = {
                id: 'clip_' + (++clipIdCounter),
                trackId: 'a2',
                name: sfxName.charAt(0).toUpperCase() + sfxName.slice(1) + ' SFX',
                type: 'audio',
                color: '#3b82f6',
                startFrame: state.timeline.playheadPosition,
                durationFrames: 15,
                volume: 1
            };

            state.clips.push(newClip);
            renderTimeline();
            saveState();
            showToast('Sound effect added', 'success');
        }

        function updateAudioVolume(value) {
            state.selectedClips.forEach(clipId => {
                const clip = state.clips.find(c => c.id === clipId);
                if (clip && clip.type === 'audio') {
                    clip.volume = parseFloat(value) / 100;
                }
            });
            document.getElementById('audioVolumeValue').textContent = value + '%';
        }

        function updateFade(type, value) {
            state.selectedClips.forEach(clipId => {
                const clip = state.clips.find(c => c.id === clipId);
                if (clip && clip.type === 'audio') {
                    clip[type === 'in' ? 'fadeIn' : 'fadeOut'] = parseFloat(value);
                }
            });
            document.getElementById(type === 'in' ? 'fadeInValue' : 'fadeOutValue').textContent = value + 's';
        }

        function applyVoiceEffect(effectName) {
            showToast(`Voice effect applied: ${effectName}`, 'success');
        }

        function reduceNoise() {
            showToast('Reducing noise... (AI feature - demo)', 'info');
        }

        // ===== TEMPLATES =====
        function loadTemplate(templateName) {
            showToast(`Loading template: ${templateName}`, 'info');
            // In a real implementation, this would load predefined clips/layouts
        }

        // ===== MODALS =====
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function hideAllModals() {
            document.querySelectorAll('.modal-backdrop').forEach(modal => {
                modal.classList.remove('show');
            });
        }

        function showExportModal() {
            showModal('exportModal');
        }

        function startExport() {
            document.getElementById('exportSettings').classList.add('hidden');
            document.getElementById('exportProgress').classList.remove('hidden');
            document.getElementById('exportFooter').classList.add('hidden');

            let progress = 0;
            const steps = [
                { percent: 10, status: 'Preparing timeline...', detail: 'Analyzing clips' },
                { percent: 25, status: 'Rendering frames...', detail: 'Processing video layers' },
                { percent: 50, status: 'Encoding video...', detail: 'Applying H.264 compression' },
                { percent: 75, status: 'Processing audio...', detail: 'Mixing audio tracks' },
                { percent: 90, status: 'Finalizing...', detail: 'Muxing streams' },
                { percent: 100, status: 'Complete!', detail: 'Ready for download' }
            ];

            let stepIndex = 0;
            const interval = setInterval(() => {
                if (stepIndex < steps.length) {
                    const step = steps[stepIndex];
                    progress = step.percent;

                    document.getElementById('exportPercent').textContent = progress + '%';
                    document.getElementById('exportStatus').textContent = step.status;
                    document.getElementById('exportDetail').textContent = step.detail;

                    const circle = document.getElementById('exportProgressCircle');
                    const circumference = 251.2;
                    circle.style.strokeDashoffset = circumference - (progress / 100) * circumference;

                    stepIndex++;
                } else {
                    clearInterval(interval);
                    setTimeout(() => {
                        showToast('Export complete! (Demo - no actual file)', 'success');
                        hideModal('exportModal');
                        // Reset modal
                        document.getElementById('exportSettings').classList.remove('hidden');
                        document.getElementById('exportProgress').classList.add('hidden');
                        document.getElementById('exportFooter').classList.remove('hidden');
                        document.getElementById('exportProgressCircle').style.strokeDashoffset = 251.2;
                    }, 1000);
                }
            }, 600);
        }

        function updateSpeedDisplay(value) {
            document.getElementById('speedDisplay').textContent = parseFloat
            (value).toFixed(1) + 'x';
            document.getElementById('speedSlider').value = value;
        }

        function setQuickSpeed(speed) {
            document.getElementById('speedSlider').value = speed;
            updateSpeedDisplay(speed);
        }

        function applySpeed() {
            const speed = parseFloat(document.getElementById('speedSlider').value);
            const maintainPitch = document.getElementById('maintainPitch').checked;
            const rippleEdit = document.getElementById('rippleEdit').checked;

            state.selectedClips.forEach(clipId => {
                const clip = state.clips.find(c => c.id === clipId);
                if (clip) {
                    const originalDuration = clip.durationFrames * (clip.speed || 1);
                    clip.speed = speed;
                    clip.durationFrames = Math.round(originalDuration / speed);
                    clip.maintainPitch = maintainPitch;
                }
            });

            renderTimeline();
            hideModal('speedModal');
            saveState();
            showToast(`Speed set to ${speed}x`, 'success');
        }

        function applyTransition() {
            const transition = state.timeline.selectedTransition;
            const duration = parseFloat(document.getElementById('modalTransitionSlider').value);

            if (!transition) {
                showToast('Please select a transition', 'warning');
                return;
            }

            // In a real implementation, this would add transition data between clips
            showToast(`Transition applied: ${transition} (${duration}s)`, 'success');
            hideModal('transitionModal');
        }

        // ===== CONTEXT MENU =====
        function handleContextMenu(e) {
            e.preventDefault();

            // Only show on clips or timeline
            if (!e.target.closest('.timeline-clip') && !e.target.closest('.track-content')) {
                return;
            }

            const menu = document.getElementById('contextMenu');
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
            menu.classList.add('show');
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('show');
        }

        // ===== TOAST NOTIFICATIONS =====
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: '<svg class="toast-icon text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',
                error: '<svg class="toast-icon text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>',
                warning: '<svg class="toast-icon text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
                info: '<svg class="toast-icon text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
            };

            toast.innerHTML = `
                ${icons[type] || icons.info}
                <span class="toast-message">${message}</span>
                <div class="toast-close" onclick="this.parentElement.remove()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </div>
            `;

            container.appendChild(toast);

            // Animate in
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // Auto remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ===== UNDO/REDO =====
        function saveState() {
            const stateSnapshot = JSON.stringify({
                clips: state.clips,
                keyframes: state.keyframes,
                tracks: state.tracks
            });

            state.undoStack.push(stateSnapshot);

            // Limit stack size
            if (state.undoStack.length > 50) {
                state.undoStack.shift();
            }

            // Clear redo stack on new action
            state.redoStack = [];

            updateUndoRedoButtons();
        }

        function undo() {
            if (state.undoStack.length === 0) {
                showToast('Nothing to undo', 'info');
                return;
            }

            // Save current state to redo stack
            const currentState = JSON.stringify({
                clips: state.clips,
                keyframes: state.keyframes,
                tracks: state.tracks
            });
            state.redoStack.push(currentState);

            // Restore previous state
            const prevState = JSON.parse(state.undoStack.pop());
            state.clips = prevState.clips;
            state.keyframes = prevState.keyframes;
            state.tracks = prevState.tracks;

            state.selectedClips = [];
            renderTimeline();
            renderPreview();
            showDefaultProperties();
            updateUndoRedoButtons();
            showToast('Undone', 'info');
        }

        function redo() {
            if (state.redoStack.length === 0) {
                showToast('Nothing to redo', 'info');
                return;
            }

            // Save current state to undo stack
            const currentState = JSON.stringify({
                clips: state.clips,
                keyframes: state.keyframes,
                tracks: state.tracks
            });
            state.undoStack.push(currentState);

            // Restore next state
            const nextState = JSON.parse(state.redoStack.pop());
            state.clips = nextState.clips;
            state.keyframes = nextState.keyframes;
            state.tracks = nextState.tracks;

            state.selectedClips = [];
            renderTimeline();
            renderPreview();
            showDefaultProperties();
            updateUndoRedoButtons();
            showToast('Redone', 'info');
        }

        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            
            if (undoBtn) undoBtn.disabled = state.undoStack.length === 0;
            if (redoBtn) redoBtn.disabled = state.redoStack.length === 0;
        }

        // ===== PROJECT MANAGEMENT =====
        function newProject() {
            if (state.clips.length > 0) {
                if (!confirm('Create a new project? Unsaved changes will be lost.')) {
                    return;
                }
            }

            state.clips = [];
            state.selectedClips = [];
            state.mediaLibrary = [];
            state.keyframes = {};
            state.timeline.playheadPosition = 0;
            state.undoStack = [];
            state.redoStack = [];
            state.currentFilter = 'none';

            Object.keys(state.colorAdjustments).forEach(key => {
                state.colorAdjustments[key] = 0;
            });

            document.getElementById('projectName').value = 'Untitled Project';

            renderTimeline();
            renderTimeRuler();
            renderMediaLibrary();
            renderPreview();
            showDefaultProperties();
            showToast('New project created', 'success');
        }

        function saveProject() {
            const projectData = {
                version: '1.0',
                name: document.getElementById('projectName').value,
                project: state.project,
                clips: state.clips,
                tracks: state.tracks,
                keyframes: state.keyframes,
                colorAdjustments: state.colorAdjustments,
                currentFilter: state.currentFilter
            };

            const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (projectData.name || 'project') + '.flowcut';
            a.click();
            URL.revokeObjectURL(url);

            showToast('Project saved', 'success');
        }

        function saveProjectAs() {
            const name = prompt('Enter project name:', document.getElementById('projectName').value);
            if (name) {
                document.getElementById('projectName').value = name;
                saveProject();
            }
        }

        function openProject() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.flowcut,.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);

                        state.project = data.project || state.project;
                        state.clips = data.clips || [];
                        state.tracks = data.tracks || state.tracks;
                        state.keyframes = data.keyframes || {};
                        state.colorAdjustments = data.colorAdjustments || state.colorAdjustments;
                        state.currentFilter = data.currentFilter || 'none';

                        document.getElementById('projectName').value = data.name || 'Loaded Project';

                        state.selectedClips = [];
                        state.undoStack = [];
                        state.redoStack = [];
                        state.timeline.playheadPosition = 0;

                        renderTimeline();
                        renderTimeRuler();
                        renderPreview();
                        showDefaultProperties();
                        showToast('Project loaded', 'success');
                    } catch (err) {
                        console.error('Failed to load project:', err);
                        showToast('Failed to load project file', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function loadProject() {
            openProject();
        }

        // ===== VIEW CONTROLS =====
        function toggleSafeZones() {
            state.showSafeZones = !state.showSafeZones;
            document.getElementById('safeZonesOverlay').classList.toggle('hidden', !state.showSafeZones);
            document.getElementById('safeZoneCheck').textContent = state.showSafeZones ? '✓' : '';
        }

        function toggleGrid() {
            state.showGrid = !state.showGrid;
            document.getElementById('gridOverlay').classList.toggle('hidden', !state.showGrid);
            document.getElementById('gridCheck').textContent = state.showGrid ? '✓' : '';
        }

        function zoomPreview(delta) {
            state.previewZoom = Math.max(25, Math.min(200, state.previewZoom + delta));
            document.getElementById('previewZoomLevel').textContent = state.previewZoom + '%';
            
            const container = document.getElementById('previewContainer');
            container.style.transform = `scale(${state.previewZoom / 100})`;
        }

        function fitPreview() {
            state.previewZoom = 100;
            document.getElementById('previewZoomLevel').textContent = '100%';
            document.getElementById('previewContainer').style.transform = 'scale(1)';
        }

        function zoomToFit() {
            fitPreview();
        }

        function zoom100() {
            fitPreview();
        }

        function toggleFullscreen() {
            const preview = document.getElementById('previewContainer');
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                preview.requestFullscreen();
            }
        }

        function setPreviewQuality(quality) {
            // In a real implementation, this would adjust canvas resolution
            console.log('Preview quality set to:', quality);
        }

        function setFPS(fps) {
            state.project.fps = parseInt(fps);
            document.getElementById('previewFps').textContent = fps + 'fps';
            renderTimeRuler();
            updateTimeDisplay();
        }

        function closeProperties() {
            deselectAll();
        }

        function handleResize() {
            // Adjust canvas size if needed
            renderPreview();
        }

        function filterStickers(query) {
            // Filter stickers based on search query
            const grid = document.getElementById('stickersGrid');
            const stickers = grid.querySelectorAll('.sticker-card');
            stickers.forEach(sticker => {
                const text = sticker.textContent.toLowerCase();
                sticker.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', init);

        // Prevent accidental page leave
        window.addEventListener('beforeunload', (e) => {
            if (state.clips.length > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
        // ==========================================
// ADVANCED FEATURES - PART 5 JAVASCRIPT
// ==========================================

// ===== LOADING OVERLAY =====
function showLoading(text = 'Loading...', detail = 'Please wait') {
    const overlay = document.getElementById('loadingOverlay');
    document.getElementById('loadingText').textContent = text;
    document.getElementById('loadingDetail').textContent = detail;
    document.getElementById('loadingProgress').style.width = '0%';
    overlay.classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('hidden');
}

function updateLoadingProgress(percent) {
    document.getElementById('loadingProgress').style.width = percent + '%';
}

function updateLoadingText(text, detail) {
    if (text) document.getElementById('loadingText').textContent = text;
    if (detail) document.getElementById('loadingDetail').textContent = detail;
}

// ===== CHROMA KEY =====
function updateChromaKey() {
    const color = document.getElementById('chromaColor').value;
    const similarity = parseInt(document.getElementById('chromaSimilarity').value);
    const smoothness = parseInt(document.getElementById('chromaSmoothness').value);
    const spill = parseInt(document.getElementById('chromaSpill').value);

    document.getElementById('chromaSimilarityValue').textContent = similarity;
    document.getElementById('chromaSmoothnessValue').textContent = smoothness;
    document.getElementById('chromaSpillValue').textContent = spill;

    state.selectedClips.forEach(clipId => {
        const clip = state.clips.find(c => c.id === clipId);
        if (clip) {
            clip.chromaKey = { color, similarity, smoothness, spill };
        }
    });

    renderPreview();
    showToast('Chroma key updated', 'success');
}

function pickChromaColor() {
    showToast('Click on the preview to pick a color', 'info');
    
    const canvasEl = document.getElementById('previewCanvas');
    canvasEl.style.cursor = 'crosshair';
    
    canvasEl.onclick = function(e) {
        const rect = canvasEl.getBoundingClientRect();
        const x = Math.floor((e.clientX - rect.left) * (canvasEl.width / rect.width));
        const y = Math.floor((e.clientY - rect.top) * (canvasEl.height / rect.height));
        
        const ctx = canvasEl.getContext('2d');
        const pixel = ctx.getImageData(x, y, 1, 1).data;
        
        const color = '#' + 
            pixel[0].toString(16).padStart(2, '0') +
            pixel[1].toString(16).padStart(2, '0') +
            pixel[2].toString(16).padStart(2, '0');
        
        document.getElementById('chromaColor').value = color;
        updateChromaKey();
        
        canvasEl.style.cursor = 'default';
        canvasEl.onclick = null;
        showToast('Color picked: ' + color, 'success');
    };
}

function applyChromaKeyToImage(imageData, settings) {
    if (!settings) return imageData;
    
    const data = imageData.data;
    const keyR = parseInt(settings.color.substr(1, 2), 16);
    const keyG = parseInt(settings.color.substr(3, 2), 16);
    const keyB = parseInt(settings.color.substr(5, 2), 16);
    
    const simThreshold = settings.similarity * 2.55;
    const smoothThreshold = settings.smoothness * 2.55;

    for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];

        const distance = Math.sqrt(
            Math.pow(r - keyR, 2) +
            Math.pow(g - keyG, 2) +
            Math.pow(b - keyB, 2)
        );

        if (distance < simThreshold) {
            data[i + 3] = 0;
        } else if (distance < simThreshold + smoothThreshold) {
            const alpha = (distance - simThreshold) / smoothThreshold;
            data[i + 3] = Math.round(alpha * 255);
        }
    }

    return imageData;
}

// ===== MASKING =====
let currentMask = null;

function createMask(type) {
    currentMask = {
        type,
        feather: 0,
        inverted: false
    };

    if (type === 'rectangle') {
        currentMask.bounds = { x: 0.2, y: 0.2, width: 0.6, height: 0.6 };
    } else if (type === 'ellipse') {
        currentMask.bounds = { cx: 0.5, cy: 0.5, rx: 0.3, ry: 0.3 };
    } else {
        currentMask.points = [];
    }

    state.selectedClips.forEach(clipId => {
        const clip = state.clips.find(c => c.id === clipId);
        if (clip) clip.mask = currentMask;
    });

    showToast(`${type} mask created`, 'success');
    renderPreview();
}

function updateMaskFeather(value) {
    if (currentMask) {
        currentMask.feather = parseInt(value);
        renderPreview();
    }
}

function toggleInvertMask(inverted) {
    if (currentMask) {
        currentMask.inverted = inverted;
        renderPreview();
    }
}

// ===== MOTION TRACKING =====
function startMotionTracking() {
    showToast('Motion tracking: Select an area to track (demo)', 'info');
}

function trackFace() {
    showToast('Face tracking enabled (demo)', 'info');
}

function trackObject() {
    showToast('Object tracking enabled (demo)', 'info');
}

// ===== BLEND MODES =====
function setBlendMode(mode) {
    state.selectedClips.forEach(clipId => {
        const clip = state.clips.find(c => c.id === clipId);
        if (clip) clip.blendMode = mode;
    });
    renderPreview();
    showToast('Blend mode: ' + mode, 'info');
}

// ===== LAYERS PANEL =====
function renderLayersPanel() {
    const container = document.getElementById('layersPanel');
    if (!container) return;

    const frame = state.timeline.playheadPosition;
    const visibleClips = state.clips
        .filter(c => c.startFrame <= frame && c.startFrame + c.durationFrames > frame && c.type !== 'audio')
        .sort((a, b) => {
            const trackA = state.tracks.findIndex(t => t.id === a.trackId);
            const trackB = state.tracks.findIndex(t => t.id === b.trackId);
            return trackA - trackB;
        });

    if (visibleClips.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4 text-sm">No visible layers</div>';
        return;
    }

    container.innerHTML = visibleClips.map(clip => `
        <div class="layer-item ${state.selectedClips.includes(clip.id) ? 'selected' : ''}" 
             onclick="selectLayerClip('${clip.id}')">
            <div class="layer-thumbnail" style="background: ${clip.color}"></div>
            <span class="layer-name">${clip.name}</span>
        </div>
    `).join('');
}

function selectLayerClip(clipId) {
    state.selectedClips = [clipId];
    renderTimeline();
    renderLayersPanel();
    const clip = state.clips.find(c => c.id === clipId);
    if (clip) showClipProperties(clip);
}

function addNewLayer() {
    addTrack('video');
}

// ===== MARKERS =====
let markers = [];

function addMarker(label) {
    const marker = {
        id: 'marker_' + Date.now(),
        frame: state.timeline.playheadPosition,
        label: label || `Marker ${markers.length + 1}`,
        color: '#fbbf24'
    };
    
    markers.push(marker);
    renderMarkers();
    renderMarkersPanel();
    showToast('Marker added', 'success');
}

function renderMarkers() {
    const container = document.getElementById('tracksContainer');
    container.querySelectorAll('.timeline-marker').forEach(m => m.remove());
    
    markers.forEach(marker => {
        const pixelsPerFrame = state.timeline.zoom / state.project.fps;
        const left = 140 + marker.frame * pixelsPerFrame;
        
        const el = document.createElement('div');
        el.className = 'timeline-marker';
        el.style.left = left + 'px';
        el.style.height = '100%';
        el.title = marker.label;
        el.onclick = () => {
            state.timeline.playheadPosition = marker.frame;
            updatePlayhead();
            renderPreview();
        };
        
        container.appendChild(el);
    });
}

function renderMarkersPanel() {
    const container = document.getElementById('markersPanel');
    if (!container) return;

    if (markers.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4 text-sm">No markers</div>';
        return;
    }

    container.innerHTML = markers.map((m, i) => `
        <div class="flex items-center gap-2 p-2 bg-[#252540] rounded mb-1">
            <div class="w-3 h-3 rounded" style="background: ${m.color}"></div>
            <span class="flex-1 text-xs truncate">${m.label}</span>
            <span class="text-xs text-muted">${formatTimecode(m.frame)}</span>
            <button class="text-red-400 hover:text-red-300 text-xs" onclick="deleteMarker(${i})">×</button>
        </div>
    `).join('');
}

function deleteMarker(index) {
    markers.splice(index, 1);
    renderMarkers();
    renderMarkersPanel();
}

// ===== KEYFRAME EDITOR =====
let currentKFProperty = 'x';
let bezierPoints = { p1: { x: 0.3, y: 0.3 }, p2: { x: 0.7, y: 0.7 } };

function openKeyframeEditor() {
    if (state.selectedClips.length === 0) {
        showToast('Select a clip first', 'warning');
        return;
    }
    showModal('keyframeModal');
    renderCurveCanvas();
}

function selectKFProperty(prop) {
    currentKFProperty = prop;
    document.querySelectorAll('#keyframeProperties > div').forEach(el => {
        el.classList.toggle('bg-purple-600', el.textContent.toLowerCase().includes(prop));
    });
    renderCurveCanvas();
}

function renderCurveCanvas() {
    const canvas = document.getElementById('curveCanvas');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const w = canvas.width;
    const h = canvas.height;

    // Background
    ctx.fillStyle = '#1a1a2e';
    ctx.fillRect(0, 0, w, h);

    // Grid
    ctx.strokeStyle = '#2a2a4a';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 8; i++) {
        ctx.beginPath();
        ctx.moveTo(i * w / 8, 0);
        ctx.lineTo(i * w / 8, h);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0, i * h / 8);
        ctx.lineTo(w, i * h / 8);
        ctx.stroke();
    }

    // Curve
    ctx.strokeStyle = '#8b5cf6';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(0, h);
    
    for (let t = 0; t <= 1; t += 0.02) {
        const x = t * w;
        const y = h - cubicBezier(t) * h;
        ctx.lineTo(x, y);
    }
    ctx.stroke();

    // Keyframe dots
    const clipId = state.selectedClips[0];
    if (clipId && state.keyframes[clipId] && state.keyframes[clipId][currentKFProperty]) {
        const clip = state.clips.find(c => c.id === clipId);
        const kfs = state.keyframes[clipId][currentKFProperty];
        
        ctx.fillStyle = '#fbbf24';
        kfs.forEach(kf => {
            const x = (kf.frame / clip.durationFrames) * w;
            ctx.beginPath();
            ctx.arc(x, h / 2, 5, 0, Math.PI * 2);
            ctx.fill();
        });
    }
}

function cubicBezier(t) {
    const p0 = 0, p1 = bezierPoints.p1.y, p2 = bezierPoints.p2.y, p3 = 1;
    return Math.pow(1-t, 3) * p0 +
           3 * Math.pow(1-t, 2) * t * p1 +
           3 * (1-t) * Math.pow(t, 2) * p2 +
           Math.pow(t, 3) * p3;
}

function setEasing(type) {
    const presets = {
        'linear': { p1: { x: 0, y: 0 }, p2: { x: 1, y: 1 } },
        'ease': { p1: { x: 0.25, y: 0.1 }, p2: { x: 0.25, y: 1 } },
        'ease-in': { p1: { x: 0.42, y: 0 }, p2: { x: 1, y: 1 } },
        'ease-out': { p1: { x: 0, y: 0 }, p2: { x: 0.58, y: 1 } },
        'ease-in-out': { p1: { x: 0.42, y: 0 }, p2: { x: 0.58, y: 1 } },
        'bounce': { p1: { x: 0.68, y: -0.55 }, p2: { x: 0.27, y: 1.55 } }
    };

    bezierPoints = presets[type] || presets['linear'];
    renderCurveCanvas();
    showToast('Easing: ' + type, 'info');
}

function clearAllKeyframes() {
    const clipId = state.selectedClips[0];
    if (clipId && state.keyframes[clipId]) {
        delete state.keyframes[clipId][currentKFProperty];
        renderCurveCanvas();
        renderTimeline();
        showToast('Keyframes cleared', 'info');
    }
}

function saveKeyframeChanges() {
    const clipId = state.selectedClips[0];
    if (clipId && state.keyframes[clipId] && state.keyframes[clipId][currentKFProperty]) {
        state.keyframes[clipId][currentKFProperty].forEach(kf => {
            kf.easing = `cubic-bezier(${bezierPoints.p1.x},${bezierPoints.p1.y},${bezierPoints.p2.x},${bezierPoints.p2.y})`;
        });
    }
    
    hideModal('keyframeModal');
    saveState();
    showToast('Keyframes saved', 'success');
}

// ===== COLOR GRADING =====
let colorGradingSettings = {
    exposure: 0,
    gamma: 0,
    lift: 0,
    gain: 0
};

function openColorGrading() {
    showModal('colorGradingModal');
    renderHistogram();
}

function updateColorGrading(prop, value) {
    colorGradingSettings[prop] = parseInt(value);
    document.getElementById(prop + 'Value').textContent = value;
    renderPreview();
}

function renderHistogram() {
    const container = document.getElementById('histogramDisplay');
    if (!container) return;

    container.innerHTML = '';
    for (let i = 0; i < 64; i++) {
        const height = 20 + Math.random() * 80;
        const bar = document.createElement('div');
        bar.className = 'histogram-bar';
        bar.style.height = height + '%';
        container.appendChild(bar);
    }
}

function resetColorGrading() {
    colorGradingSettings = { exposure: 0, gamma: 0, lift: 0, gain: 0 };
    
    ['exposure', 'gamma', 'lift', 'gain'].forEach(prop => {
        const slider = document.getElementById(prop + 'Slider');
        const value = document.getElementById(prop + 'Value');
        if (slider) slider.value = 0;
        if (value) value.textContent = '0';
    });
    
    renderPreview();
    showToast('Color grading reset', 'info');
}

function applyColorGrading() {
    state.selectedClips.forEach(clipId => {
        const clip = state.clips.find(c => c.id === clipId);
        if (clip) {
            clip.colorGrading = { ...colorGradingSettings };
        }
    });

    hideModal('colorGradingModal');
    saveState();
    showToast('Color grading applied', 'success');
}

function applyLUTPreset(preset) {
    if (!preset) return;
    
    // Simulate LUT application
    const luts = {
        'cinematic': { exposure: 10, gamma: -5, lift: -10, gain: 15 },
        'vintage': { exposure: -5, gamma: 10, lift: 5, gain: -10 },
        'teal-orange': { exposure: 5, gamma: 0, lift: -5, gain: 10 },
        'noir': { exposure: -20, gamma: 15, lift: -15, gain: 5 },
        'pastel': { exposure: 15, gamma: 5, lift: 10, gain: -5 }
    };

    if (luts[preset]) {
        Object.entries(luts[preset]).forEach(([prop, value]) => {
            colorGradingSettings[prop] = value;
            const slider = document.getElementById(prop + 'Slider');
            const valueEl = document.getElementById(prop + 'Value');
            if (slider) slider.value = value;
            if (valueEl) valueEl.textContent = value;
        });
        
        renderPreview();
        showToast('LUT applied: ' + preset, 'success');
    }
}

// ===== UPDATE RENDER PREVIEW TO USE NEW FEATURES =====
const originalRenderPreview = renderPreview;
renderPreview = function() {
    // Call original render
    originalRenderPreview();
    
    // Update layers panel when exists
    if (document.getElementById('layersPanel')) {
        renderLayersPanel();
    }
};

// ===== INITIALIZE ADVANCED FEATURES =====
function initAdvancedFeatures() {
    // Render markers if any
    renderMarkers();
    renderMarkersPanel();
    
    // Initialize histogram
    renderHistogram();
    
    console.log('Advanced features initialized');
}

// Call on load
document.addEventListener('DOMContentLoaded', function() {
    // Wait for main init to complete
    setTimeout(initAdvancedFeatures, 100);
});
    </script>
</body>
</html>